<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YAA –¶–ï–†–ï–ë–†–û</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Press Start 2P', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #fff;
      min-height: 100vh;
      font-size: 10px;
      line-height: 1.8;
    }

    /* 8-bit pixel border effect */
    .pixel-border {
      border: 4px solid #00FF88;
      box-shadow:
        4px 4px 0 #00AA55,
        -2px -2px 0 #00FF88 inset;
    }

    /* Logo image */
    .logo-img {
      width: 80px;
      height: 80px;
      border-radius: 0;
      margin-bottom: 15px;
      image-rendering: pixelated;
      border: 3px solid #00FF88;
      box-shadow: 3px 3px 0 #00AA55;
    }

    /* 8-bit animated brain logo */
    .brain-logo {
      font-size: 48px;
      margin-bottom: 10px;
      animation: pulse 1.5s ease-in-out infinite;
      text-shadow: 3px 3px 0 #00AA55;
      filter: drop-shadow(0 0 10px rgba(0, 255, 136, 0.5));
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    @keyframes blink {
      0%, 49% { opacity: 1; }
      50%, 100% { opacity: 0.7; }
    }
    @keyframes scanline {
      0% { background-position: 0 0; }
      100% { background-position: 0 4px; }
    }

    /* Glitch effect for title */
    .glitch-title {
      position: relative;
    }
    .glitch-title::before,
    .glitch-title::after {
      content: attr(data-text);
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .glitch-title::before {
      left: 2px;
      text-shadow: -2px 0 #ff0066;
      animation: glitch1 2s infinite linear alternate-reverse;
      clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
    }
    .glitch-title::after {
      left: -2px;
      text-shadow: 2px 0 #00ccff;
      animation: glitch2 3s infinite linear alternate-reverse;
      clip-path: polygon(0 55%, 100% 55%, 100% 100%, 0 100%);
    }
    @keyframes glitch1 {
      0%, 90%, 100% { transform: translateX(0); }
      92%, 94%, 96%, 98% { transform: translateX(-2px); }
      91%, 93%, 95%, 97%, 99% { transform: translateX(2px); }
    }
    @keyframes glitch2 {
      0%, 90%, 100% { transform: translateX(0); }
      92%, 94%, 96%, 98% { transform: translateX(2px); }
      91%, 93%, 95%, 97%, 99% { transform: translateX(-2px); }
    }

    /* Selection Screens */
    .selection-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
      background:
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,255,136,0.03) 2px, rgba(0,255,136,0.03) 4px),
        linear-gradient(135deg, #0a0a0a 0%, #0a1a0a 100%);
    }
    .selection-box {
      background: #111;
      padding: 40px;
      border-radius: 0;
      border: 4px solid #00FF88;
      box-shadow: 6px 6px 0 #00AA55;
      text-align: center;
      max-width: 520px;
      width: 90%;
    }
    .selection-box h1 { color: #00FF88; margin-bottom: 10px; font-size: 16px; text-shadow: 2px 2px 0 #00AA55; }
    .selection-box p { color: #888; margin-bottom: 30px; font-size: 8px; }
    .selection-box .subtitle { color: #666; font-size: 12px; margin-top: -20px; margin-bottom: 30px; }

    .choice-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    .choice-btn {
      padding: 25px 15px;
      background: #1a1a1a;
      border: 3px solid #333;
      border-radius: 0;
      color: #fff;
      cursor: pointer;
      transition: all 0.1s;
      text-align: center;
    }
    .choice-btn:hover {
      border-color: #00FF88;
      background: #1a2a1a;
      transform: translate(-2px, -2px);
      box-shadow: 4px 4px 0 #00AA55;
    }
    .choice-btn.selected {
      border-color: #00FF88;
      background: rgba(0,255,136,0.15);
      box-shadow: 4px 4px 0 #00AA55;
    }
    .choice-btn .flag { font-size: 36px; margin-bottom: 10px; }
    .choice-btn .label { font-size: 11px; font-weight: bold; color: #00FF88; text-shadow: 1px 1px 0 #00AA55; }
    .choice-btn .desc { font-size: 7px; color: #888; margin-top: 8px; line-height: 1.6; font-family: -apple-system, sans-serif; }

    .btn-continue {
      width: 100%;
      padding: 14px;
      background: #00FF88;
      color: #000;
      border: 3px solid #00AA55;
      border-radius: 0;
      font-weight: bold;
      font-size: 10px;
      cursor: pointer;
      margin-top: 10px;
      box-shadow: 4px 4px 0 #006633;
      text-transform: uppercase;
    }
    .btn-continue:hover {
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0 #006633;
    }
    .btn-continue:active {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 #006633;
    }
    .btn-continue:disabled { opacity: 0.3; cursor: not-allowed; transform: none; box-shadow: 4px 4px 0 #333; }

    .btn-back {
      background: transparent;
      border: 2px solid #444;
      color: #888;
      padding: 10px 20px;
      border-radius: 0;
      cursor: pointer;
      margin-top: 15px;
      font-size: 8px;
    }
    .btn-back:hover { border-color: #00FF88; color: #00FF88; }

    /* Login Screen - 8-bit style */
    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
      background:
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,255,136,0.03) 2px, rgba(0,255,136,0.03) 4px),
        linear-gradient(135deg, #0a0a0a 0%, #0a1a0a 100%);
    }
    .login-box {
      background: #111;
      padding: 40px;
      border-radius: 0;
      border: 4px solid #00FF88;
      box-shadow: 6px 6px 0 #00AA55;
      text-align: center;
      min-width: 320px;
    }
    .login-box h1 { color: #00FF88; margin-bottom: 10px; font-size: 14px; text-shadow: 2px 2px 0 #00AA55; }
    .login-box p { color: #666; margin-bottom: 30px; font-size: 8px; }
    .login-box input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 0;
      border: 3px solid #333;
      background: #1a1a1a;
      color: #fff;
      font-size: 12px;
      font-family: 'Press Start 2P', monospace;
      margin-bottom: 15px;
      outline: none;
    }
    .login-box input:focus { border-color: #00FF88; box-shadow: 3px 3px 0 #00AA55; }
    .login-box button {
      width: 100%;
      padding: 14px;
      background: #00FF88;
      color: #000;
      border: 3px solid #00AA55;
      border-radius: 0;
      font-weight: bold;
      font-size: 10px;
      font-family: 'Press Start 2P', monospace;
      cursor: pointer;
      box-shadow: 4px 4px 0 #006633;
      text-transform: uppercase;
    }
    .login-box button:hover { transform: translate(-2px, -2px); box-shadow: 6px 6px 0 #006633; }
    .login-box button:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 #006633; }
    .login-error { color: #ff6666; margin-top: 10px; display: none; font-size: 8px; }

    /* Dashboard - 8-bit style */
    .dashboard {
      display: none;
      padding: 20px;
      background:
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,255,136,0.02) 2px, rgba(0,255,136,0.02) 4px);
    }
    .dashboard.active { display: block; }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background: #111;
      border: 3px solid #00FF88;
      box-shadow: 4px 4px 0 #00AA55;
    }
    h1 { color: #00FF88; margin-bottom: 5px; font-size: 12px; text-shadow: 2px 2px 0 #00AA55; }
    .subtitle { color: #666; margin-bottom: 20px; font-size: 8px; }
    .mode-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 0;
      font-size: 8px;
      font-weight: bold;
      margin-left: 10px;
      border: 2px solid;
    }
    .mode-sales { background: #00FF88; color: #000; border-color: #00AA55; }
    .mode-marketing { background: #FF6B00; color: #fff; border-color: #CC5500; }
    .region-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 0;
      font-size: 8px;
      font-weight: bold;
      background: #333;
      color: #00FF88;
      margin-left: 5px;
      border: 2px solid #00FF88;
    }

    .status {
      padding: 15px;
      border-radius: 0;
      margin: 20px 0;
      border: 3px solid #333;
      font-size: 9px;
      box-shadow: 3px 3px 0 #222;
    }
    .loading { background: #1a1a1a; color: #00FF88; border-color: #00FF88; }
    .success { background: rgba(0,255,136,0.1); border-color: #00FF88; }
    .error { background: rgba(255,0,0,0.1); border-color: #ff4444; color: #ff6666; }

    /* Competitor Search (for Marketing mode) - 8-bit style */
    .competitor-section {
      background: #111;
      border: 3px solid #FF6B00;
      border-radius: 0;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 4px 4px 0 #CC5500;
    }
    .competitor-title {
      color: #FF6B00;
      font-size: 10px;
      font-weight: bold;
      margin-bottom: 15px;
      text-shadow: 1px 1px 0 #CC5500;
    }
    .competitor-form {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    .competitor-form .filter-group { flex: 1; min-width: 150px; }
    .competitor-form .filter-group label { color: #FF6B00; }
    .competitor-form .btn-search {
      background: #FF6B00;
      color: #fff;
      padding: 10px 25px;
      white-space: nowrap;
      border: 3px solid #CC5500;
      box-shadow: 3px 3px 0 #993300;
    }
    .competitor-form .btn-search:hover {
      transform: translate(-2px, -2px);
      box-shadow: 5px 5px 0 #993300;
    }
    .competitor-results {
      margin-top: 20px;
      display: none;
    }
    .competitor-results.active { display: block; }
    .competitor-results-title {
      color: #FF6B00;
      font-size: 9px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .competitor-results-title .count {
      background: #FF6B00;
      color: #fff;
      padding: 2px 8px;
      border-radius: 0;
      font-size: 9px;
      border: 2px solid #CC5500;
    }
    .competitor-card {
      background: #1a1a1a;
      border: 2px solid #333;
      border-radius: 0;
      padding: 12px 15px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }
    .competitor-card:hover { border-color: #FF6B00; box-shadow: 2px 2px 0 #CC5500; }
    .competitor-info { flex: 1; }
    .competitor-event-title { color: #FF6B00; font-weight: bold; font-size: 9px; }
    .competitor-event-title a { color: #FF6B00; text-decoration: none; }
    .competitor-event-title a:hover { text-decoration: underline; }
    .competitor-meta { color: #666; font-size: 8px; margin-top: 4px; font-family: -apple-system, sans-serif; }
    .competitor-dates { color: #888; font-size: 8px; white-space: nowrap; text-align: right; font-family: -apple-system, sans-serif; }
    .competitor-price { color: #FF6B00; font-weight: bold; font-size: 9px; }


    /* New Events Section (for Sales mode) - 8-bit style */
    .new-events-section {
      background: #111;
      border: 3px solid #00FF88;
      border-radius: 0;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 4px 4px 0 #00AA55;
    }
    .new-events-title {
      color: #00FF88;
      font-size: 10px;
      font-weight: bold;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      text-shadow: 1px 1px 0 #00AA55;
    }
    .new-events-title .count {
      background: #00FF88;
      color: #000;
      padding: 2px 8px;
      border-radius: 0;
      font-size: 9px;
      border: 2px solid #00AA55;
    }
    .new-events-list {
      display: grid;
      gap: 10px;
    }
    .new-event-card {
      background: #1a1a1a;
      border: 2px solid #333;
      border-radius: 0;
      padding: 12px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }
    .new-event-card:hover { border-color: #00FF88; box-shadow: 2px 2px 0 #00AA55; }
    .new-event-info { flex: 1; }
    .new-event-title { color: #00FF88; font-weight: bold; font-size: 9px; }
    .new-event-title a { color: #00FF88; text-decoration: none; }
    .new-event-title a:hover { text-decoration: underline; }
    .new-event-meta { color: #666; font-size: 8px; margin-top: 4px; font-family: -apple-system, sans-serif; }
    .new-event-date { color: #888; font-size: 8px; white-space: nowrap; font-family: -apple-system, sans-serif; }

    /* Filters - 8-bit style */
    .filters {
      background: #111;
      border: 3px solid #00FF88;
      border-radius: 0;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 4px 4px 0 #00AA55;
    }
    .filters-title {
      color: #00FF88;
      font-size: 9px;
      font-weight: bold;
      margin-bottom: 15px;
      text-transform: uppercase;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      text-shadow: 1px 1px 0 #00AA55;
    }
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }
    .filter-group label {
      display: block;
      color: #888;
      font-size: 7px;
      margin-bottom: 5px;
      text-transform: uppercase;
    }
    .filter-group input,
    .filter-group select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 0;
      border: 2px solid #333;
      background: #1a1a1a;
      color: #fff;
      font-size: 11px;
      font-family: -apple-system, sans-serif;
      outline: none;
    }
    .filter-group input:focus,
    .filter-group select:focus { border-color: #00FF88; box-shadow: 2px 2px 0 #00AA55; }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: #111;
      border: 3px solid #00FF88;
      border-radius: 0;
      padding: 20px;
      box-shadow: 3px 3px 0 #00AA55;
    }
    .stat-label { color: #888; font-size: 7px; text-transform: uppercase; }
    .stat-value { color: #00FF88; font-size: 18px; font-weight: bold; margin-top: 5px; text-shadow: 2px 2px 0 #00AA55; }

    .btn-group { margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      background: #00FF88;
      color: #000;
      border: 3px solid #00AA55;
      padding: 10px 20px;
      border-radius: 0;
      font-weight: bold;
      font-size: 8px;
      cursor: pointer;
      box-shadow: 3px 3px 0 #006633;
      text-transform: uppercase;
    }
    .btn:hover { transform: translate(-2px, -2px); box-shadow: 5px 5px 0 #006633; }
    .btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0 #006633; }
    .btn-secondary { background: #333; color: #fff; border-color: #222; box-shadow: 3px 3px 0 #111; }
    .btn-secondary:hover { box-shadow: 5px 5px 0 #111; }
    .btn-logout { background: transparent; border: 2px solid #ff4444; color: #ff4444; box-shadow: 3px 3px 0 #990000; }
    .btn-logout:hover { box-shadow: 5px 5px 0 #990000; }
    .btn-change { background: transparent; border: 2px solid #00FF88; color: #00FF88; box-shadow: 3px 3px 0 #00AA55; }
    .btn-change:hover { box-shadow: 5px 5px 0 #00AA55; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-family: -apple-system, sans-serif;
    }
    th {
      text-align: left;
      padding: 12px;
      color: #00FF88;
      border-bottom: 3px solid #00FF88;
      font-size: 8px;
      text-transform: uppercase;
      position: sticky;
      top: 0;
      background: #0a0a0a;
      font-family: 'Press Start 2P', monospace;
    }
    td {
      padding: 12px;
      border-bottom: 2px solid #222;
      color: #999;
      font-size: 12px;
    }
    td:first-child { color: #00FF88; }
    .price-cell { color: #00FF88; text-align: right; font-weight: bold; }
    .date-cell { color: #888; font-size: 11px; }
    a { color: #00FF88; text-decoration: none; }
    a:hover { text-decoration: underline; color: #66FFAA; }
    tr:hover { background: rgba(0,255,136,0.08); }

    .table-container {
      max-height: 600px;
      overflow-y: auto;
      border: 3px solid #00FF88;
      border-radius: 0;
      box-shadow: 4px 4px 0 #00AA55;
      background: #0a0a0a;
    }

    .results-info {
      color: #666;
      text-align: center;
      padding: 10px;
      font-size: 8px;
    }

    /* Comments - 8-bit style */
    .comment-cell { max-width: 200px; font-size: 11px; color: #888; }
    .comment-text {
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 0;
      background: #1a1a1a;
      border: 2px solid #333;
      min-height: 24px;
      display: inline-block;
      min-width: 100px;
      font-size: 10px;
    }
    .comment-text:hover { border-color: #00FF88; box-shadow: 2px 2px 0 #00AA55; }
    .comment-text.empty { color: #555; font-style: italic; }
    .comment-text.has-comment { color: #00FF88; }

    /* Modal - 8-bit style */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: #111;
      border: 4px solid #00FF88;
      border-radius: 0;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 6px 6px 0 #00AA55;
    }
    .modal h3 { color: #00FF88; margin-bottom: 10px; font-size: 11px; text-shadow: 2px 2px 0 #00AA55; }
    .modal-event-title { color: #888; font-size: 9px; margin-bottom: 20px; font-family: -apple-system, sans-serif; }
    .modal textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border-radius: 0;
      border: 3px solid #333;
      background: #1a1a1a;
      color: #fff;
      font-size: 12px;
      font-family: -apple-system, sans-serif;
      resize: vertical;
      outline: none;
    }
    .modal textarea:focus { border-color: #00FF88; box-shadow: 3px 3px 0 #00AA55; }
    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }
    .modal-buttons button {
      padding: 10px 20px;
      border-radius: 0;
      border: 3px solid;
      font-weight: bold;
      cursor: pointer;
      font-size: 9px;
      font-family: 'Press Start 2P', monospace;
      text-transform: uppercase;
    }
    .btn-save { background: #00FF88; color: #000; border-color: #00AA55; box-shadow: 3px 3px 0 #006633; }
    .btn-save:hover { transform: translate(-2px, -2px); box-shadow: 5px 5px 0 #006633; }
    .btn-cancel { background: #333; color: #fff; border-color: #222; box-shadow: 3px 3px 0 #111; }
    .btn-cancel:hover { transform: translate(-2px, -2px); box-shadow: 5px 5px 0 #111; }
    .btn-save:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: 3px 3px 0 #333; }

    /* Flatpickr */
    .flatpickr-calendar { background: #1a1a1a !important; border: 1px solid #333 !important; }
    .flatpickr-months .flatpickr-month { background: #1a1a1a !important; color: #00FF88 !important; }
    .flatpickr-current-month .flatpickr-monthDropdown-months { background: #1a1a1a !important; color: #00FF88 !important; }
    .flatpickr-current-month input.cur-year { color: #00FF88 !important; }
    .flatpickr-months .flatpickr-prev-month, .flatpickr-months .flatpickr-next-month { color: #00FF88 !important; fill: #00FF88 !important; }
    .flatpickr-weekdays { background: #1a1a1a !important; }
    span.flatpickr-weekday { color: #666 !important; background: #1a1a1a !important; }
    .flatpickr-days { background: #1a1a1a !important; }
    .flatpickr-day { color: #fff !important; border-radius: 4px !important; }
    .flatpickr-day:hover { background: #333 !important; border-color: #333 !important; }
    .flatpickr-day.selected { background: #00FF88 !important; border-color: #00FF88 !important; color: #000 !important; }
    .flatpickr-day.today { border-color: #00FF88 !important; }
    .flatpickr-day.prevMonthDay, .flatpickr-day.nextMonthDay { color: #444 !important; }

    /* Pixel cursor blink effect */
    .login-box input::placeholder {
      animation: blink 1s step-end infinite;
    }

    /* Scrollbar - 8-bit style */
    ::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    ::-webkit-scrollbar-track {
      background: #111;
      border: 2px solid #00FF88;
    }
    ::-webkit-scrollbar-thumb {
      background: #00FF88;
      border: 2px solid #00AA55;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #00AA55;
    }

    /* Mobile */
    @media (max-width: 768px) {
      body { font-size: 9px; }
      .dashboard { padding: 10px; }
      .header { flex-direction: column; align-items: flex-start; padding: 10px; }
      .header > div:last-child { width: 100%; display: flex; gap: 10px; }
      .header > div:last-child .btn { flex: 1; font-size: 7px; padding: 8px 10px; }
      .choice-grid { grid-template-columns: 1fr; }
      .filters-grid { grid-template-columns: 1fr; }
      .stats { grid-template-columns: repeat(2, 1fr); }
      .stat-value { font-size: 14px; }
      .btn-group { flex-direction: column; }
      .btn-group .btn { width: 100%; }
      .table-container { overflow-x: auto; }
      table { min-width: 700px; font-size: 11px; }
      th { font-size: 7px; }
      .new-event-card { flex-direction: column; align-items: flex-start; }
      .brain-logo { font-size: 36px; }
      .login-box, .selection-box { padding: 25px; }
      h1 { font-size: 10px; }
    }

    /* Custom dropdown styles */
    .custom-dropdown-wrapper {
      position: relative;
      width: 100%;
    }

    .custom-dropdown-header {
      padding: 8px 30px 8px 8px;
      background: #1a1a1a;
      color: #fff;
      border: 2px solid #00ff00;
      cursor: pointer;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      user-select: none;
    }

    .custom-dropdown-header:hover {
      background: #252525;
    }

    .dropdown-arrow {
      position: absolute;
      right: 8px;
      color: #00ff00;
      font-size: 10px;
      transition: transform 0.2s;
    }

    .custom-dropdown-header.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .custom-dropdown-content {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #1a1a1a;
      border: 2px solid #00ff00;
      border-top: none;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .dropdown-search {
      width: calc(100% - 16px);
      padding: 8px;
      margin: 8px;
      background: #252525;
      color: #fff;
      border: 1px solid #00ff00;
      font-size: 11px;
      outline: none;
    }

    .dropdown-search::placeholder {
      color: #888;
    }

    .dropdown-options {
      max-height: 240px;
      overflow-y: auto;
    }

    .dropdown-option {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #fff;
    }

    .dropdown-option:hover {
      background: #252525;
    }

    .dropdown-option.selected {
      background: #1a3a1a;
    }

    .dropdown-option-checkbox {
      width: 14px;
      height: 14px;
      border: 1px solid #00ff00;
      background: #1a1a1a;
      display: inline-block;
      position: relative;
      flex-shrink: 0;
    }

    .dropdown-option.selected .dropdown-option-checkbox {
      background: #00ff00;
    }

    .dropdown-option.selected .dropdown-option-checkbox::after {
      content: '‚úì';
      position: absolute;
      top: -2px;
      left: 2px;
      color: #000;
      font-size: 12px;
      font-weight: bold;
    }

    #filter-genre option {
      padding: 5px;
      cursor: pointer;
    }

    #filter-genre option:hover {
      background: #00ff0033;
    }

    #filter-genre option:checked {
      background: #00ff00;
      color: #000;
      font-weight: bold;
    }

    .selected-items {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 8px;
      min-height: 24px;
    }

    .genre-tag {
      background: #00ff00;
      color: #000;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: bold;
      box-shadow: 2px 2px 0 #00AA55;
    }

    .genre-tag .remove {
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      line-height: 1;
    }

    .genre-tag .remove:hover {
      color: #ff0000;
    }

  </style>
</head>
<body>

  <!-- Preloader -->
  <div id="preloader" class="preloader">
    <div class="preloader-content">
      <div class="preloader-brain">üß†</div>
      <h1 class="preloader-title">YAA –¶–ï–†–ï–ë–†–û</h1>
      <div class="preloader-bar">
        <div class="preloader-progress" id="preloader-progress"></div>
      </div>
      <p class="preloader-text" id="preloader-text">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</p>
      <p class="preloader-joke" id="preloader-joke"></p>
    </div>
  </div>

  <style>
    .preloader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0a0a0a;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
    }
    .preloader.hidden {
      display: none;
    }
    .preloader-content {
      text-align: center;
      position: relative;
      z-index: 10;
    }
    .preloader-brain {
      font-size: 64px;
      line-height: 1;
      display: block;
      animation: pulse-brain 1s ease-in-out infinite;
      text-shadow: 0 0 30px rgba(0, 255, 136, 0.6);
    }
    @keyframes pulse-brain {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.15); opacity: 0.8; }
    }
    .preloader-title {
      color: #00FF88;
      font-size: 18px;
      margin: 25px 0 20px 0;
      text-shadow: 2px 2px 0 #00AA55;
      font-family: 'Press Start 2P', monospace;
      letter-spacing: 2px;
    }
    .preloader-bar {
      width: 280px;
      height: 16px;
      background: #1a1a1a;
      border: 3px solid #00FF88;
      margin: 20px auto;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
    }
    .preloader-progress {
      height: 100%;
      width: 0%;
      background: #00FF88;
      box-shadow: 0 0 10px #00FF88;
      transition: width 0.4s ease;
    }
    .preloader-text {
      color: #00FF88;
      font-size: 9px;
      font-family: 'Press Start 2P', monospace;
      margin-bottom: 20px;
      letter-spacing: 1px;
    }
    .preloader-joke {
      color: #666;
      font-size: 12px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 320px;
      margin: 0 auto;
      line-height: 1.5;
      min-height: 36px;
    }
  </style>

  <script>
    // –ü—Ä–µ–ª–æ–∞–¥–µ—Ä —Å —à—É—Ç–∫–∞–º–∏
    const preloaderJokes = [
      "üîÆ –°–≤–µ—Ä—è—é —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–Ω—ã–º –ú–µ—Ä–∫—É—Ä–∏–µ–º...",
      "üé∏ –ü—Ä–æ–≤–µ—Ä—è—é, –Ω–µ –æ—Ç–º–µ–Ω–∏–ª—Å—è –ª–∏ –æ—á–µ—Ä–µ–¥–Ω–æ–π —Ç—É—Ä...",
      "üåô –õ—É–Ω–∞ –≤ –ö–æ–∑–µ—Ä–æ–≥–µ ‚Äî –≤—Ä–µ–º—è –¥–ª—è —Ä–æ–∫-–∫–æ–Ω—Ü–µ—Ä—Ç–æ–≤",
      "üé§ –ó–∞–≥—Ä—É–∂–∞—é –±–∞–∑—É... –ë–∞—Å—Ç–∞ –æ–ø—è—Ç—å –≤ —Ç—É—Ä–µ!",
      "‚≠ê –Æ–ø–∏—Ç–µ—Ä –≤ –ø—è—Ç–æ–º –¥–æ–º–µ ‚Äî –∂–¥–∏ —Ñ–µ—Å—Ç–∏–≤–∞–ª–µ–π",
      "üé™ –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ –≤–∏–±—Ä–∞—Ü–∏—è–º –∏–≤–µ–Ω—Ç-–∏–Ω–¥—É—Å—Ç—Ä–∏–∏...",
      "üî• –ú–∞—Ä—Å –≤ –û–≤–Ω–µ ‚Äî —Å–µ–∑–æ–Ω –ø—Ä–æ–º–æ –Ω–∞—á–∞–ª—Å—è",
      "üéπ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é —á–∞–∫—Ä—ã —Å –±–∏–ª–µ—Ç–∞–º–∏...",
      "üåü –í–µ–Ω–µ—Ä–∞ –±–ª–∞–≥–æ–≤–æ–ª–∏—Ç —Å—Ç–µ–Ω–¥–∞–ø–µ—Ä–∞–º —Å–µ–≥–æ–¥–Ω—è",
      "üé≠ –ù–µ–ø—Ç—É–Ω —à–µ–ø—á–µ—Ç: —Ç–µ–∞—Ç—Ä –±—É–¥–µ—Ç –æ–≥–æ–Ω—å",
      "üöÄ –ê—Å—Ç—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–µ–∫—Ü–∏—è –≤ –º–∏—Ä –∏–≤–µ–Ω—Ç–æ–≤...",
      "üí´ –ü–ª—É—Ç–æ–Ω —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–µ–Ω ‚Äî –æ–ª–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è",
      "üéµ –ö–∞–ª–∏–±—Ä—É—é —á–∞—Å—Ç–æ—Ç—ã –ø–æ–¥ –≤–∞–π–± –∞—É–¥–∏—Ç–æ—Ä–∏–∏...",
      "üîî –°–∞—Ç—É—Ä–Ω: –¥–µ–¥–ª–∞–π–Ω—ã –ø–æ –∏–≤–µ–Ω—Ç–∞–º –≥–æ—Ä—è—Ç!"
    ];

    const preloaderSteps = [
      { text: "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...", percent: 15 },
      { text: "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ...", percent: 35 },
      { text: "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...", percent: 60 },
      { text: "–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...", percent: 85 },
      { text: "–ì–æ—Ç–æ–≤–æ!", percent: 100 }
    ];

    let preloaderStep = 0;

    function runPreloader() {
      const progress = document.getElementById('preloader-progress');
      const text = document.getElementById('preloader-text');
      const joke = document.getElementById('preloader-joke');

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —à—É—Ç–∫—É
      joke.textContent = preloaderJokes[Math.floor(Math.random() * preloaderJokes.length)];

      function nextStep() {
        if (preloaderStep < preloaderSteps.length) {
          const step = preloaderSteps[preloaderStep];
          progress.style.width = step.percent + '%';
          text.textContent = step.text;

          // –ú–µ–Ω—è–µ–º —à—É—Ç–∫—É –∫–∞–∂–¥—ã–µ 2 —à–∞–≥–∞
          if (preloaderStep % 2 === 0) {
            joke.textContent = preloaderJokes[Math.floor(Math.random() * preloaderJokes.length)];
          }

          preloaderStep++;
          setTimeout(nextStep, 700);
        } else {
          // –ü—Ä–µ–ª–æ–∞–¥–µ—Ä –∑–∞–≤–µ—Ä—à—ë–Ω ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º
          setTimeout(() => {
            document.getElementById('preloader').classList.add('hidden');
          }, 300);
        }
      }

      setTimeout(nextStep, 400);
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–µ–ª–æ–∞–¥–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', runPreloader);
  </script>

  <!-- Login Screen -->
  <div id="login-screen" class="login-screen">
    <div class="login-box">
      <div class="brain-logo">üß†</div>
      <h1 class="glitch-title" data-text="YAA –¶–ï–†–ï–ë–†–û">YAA –¶–ï–†–ï–ë–†–û</h1>
      <p>–í–í–ï–î–ò–¢–ï –ü–ê–†–û–õ–¨ –î–õ–Ø –î–û–°–¢–£–ü–ê</p>
      <input type="password" id="password-input" placeholder="* * * * * *" onkeypress="if(event.key==='Enter')login()">
      <button onclick="login()">[ –í–û–ô–¢–ò ]</button>
      <p class="login-error" id="login-error">// –ù–ï–í–ï–†–ù–´–ô –ü–ê–†–û–õ–¨ //</p>
    </div>
  </div>

  <!-- Region Selection -->
  <div id="region-screen" class="selection-screen" style="display:none;">
    <div class="selection-box">
      <div class="brain-logo">üß†</div>
      <h1 class="glitch-title" data-text="YAA –¶–ï–†–ï–ë–†–û">YAA –¶–ï–†–ï–ë–†–û</h1>
      <p>–í–´–ë–ï–†–ò–¢–ï –†–ï–ì–ò–û–ù</p>
      <div class="choice-grid">
        <div class="choice-btn" data-region="kz" onclick="selectRegion('kz')">
          <div class="flag">üá∞üáø</div>
          <div class="label">YAA KZ</div>
          <div class="desc">–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω</div>
        </div>
        <div class="choice-btn" data-region="ru" onclick="selectRegion('ru')">
          <div class="flag">üá∑üá∫</div>
          <div class="label">YAA RU</div>
          <div class="desc">–†–æ—Å—Å–∏—è</div>
        </div>
      </div>
      <button class="btn-continue" id="btn-region-continue" onclick="confirmRegion()" disabled>[ –ü–†–û–î–û–õ–ñ–ò–¢–¨ ]</button>
      <button class="btn-back" onclick="logout()">‚óÑ –í–´–ô–¢–ò</button>
    </div>
  </div>

  <!-- Purpose Selection -->
  <div id="purpose-screen" class="selection-screen" style="display:none;">
    <div class="selection-box">
      <div class="brain-logo">üß†</div>
      <h1 class="glitch-title" data-text="YAA">YAA <span id="purpose-region-label">KZ</span></h1>
      <p>–í–´–ë–ï–†–ò–¢–ï –†–ï–ñ–ò–ú –†–ê–ë–û–¢–´</p>
      <div class="choice-grid">
        <div class="choice-btn" data-purpose="sales" onclick="selectPurpose('sales')">
          <div class="flag">üí∞</div>
          <div class="label">–ü—Ä–æ–¥–∞–∂–∏</div>
          <div class="desc">–í—Å–µ —Å–æ–±—ã—Ç–∏—è + –Ω–æ–≤—ã–µ –¥–ª—è —Å–≤—è–∑–∏ —Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞–º–∏. –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ.</div>
        </div>
        <div class="choice-btn" data-purpose="marketing" onclick="selectPurpose('marketing')">
          <div class="flag">üì¢</div>
          <div class="label">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</div>
          <div class="desc">–¢–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è. –ë–µ–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö.</div>
        </div>
      </div>
      <button class="btn-continue" id="btn-purpose-continue" onclick="confirmPurpose()" disabled>[ –ü–†–û–î–û–õ–ñ–ò–¢–¨ ]</button>
      <button class="btn-back" onclick="backToRegion()">‚óÑ –ù–ê–ó–ê–î</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="dashboard">
    <div class="header">
      <div>
        <h1>üß† YAA –¶–ï–†–ï–ë–†–û
          <span class="region-badge" id="dash-region"></span>
          <span class="mode-badge" id="dash-mode"></span>
        </h1>
        <p class="subtitle">// LIVE DASHBOARD ‚Ä¢ <span id="dash-table-name"></span> //</p>
      </div>
      <div>
        <button class="btn btn-change" onclick="changeMode()">‚óÑ –†–ï–ñ–ò–ú</button>
        <button class="btn btn-logout" onclick="logout()">‚úï –í–´–•–û–î</button>
      </div>
    </div>

    <div id="status" class="status loading">‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase...</div>

    <!-- Competitor Search (only for Marketing mode) -->
    <div id="competitor-section" class="competitor-section" style="display:none;">
      <div class="competitor-title">üéØ –ü–æ–∏—Å–∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ ‚Äî —É–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≥–æ—Ä–æ–¥ –≤–∞—à–µ–≥–æ —Å–æ–±—ã—Ç–∏—è</div>
      <div class="competitor-form">
        <div class="filter-group">
          <label>–î–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è (–æ—Ç)</label>
          <input type="date" id="competitor-date-from">
        </div>
        <div class="filter-group">
          <label>–î–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è (–¥–æ)</label>
          <input type="date" id="competitor-date-to">
        </div>
        <div class="filter-group">
          <label>–ì–æ—Ä–æ–¥</label>
          <select id="competitor-city">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
          </select>
        </div>
        <div class="filter-group">
          <label>–ñ–∞–Ω—Ä</label>
          <div class="custom-dropdown-wrapper">
            <div class="custom-dropdown-header" onclick="toggleCompetitorGenreDropdown()">
              <span id="competitor-genre-dropdown-text">–í—Å–µ –∂–∞–Ω—Ä—ã</span>
              <span class="dropdown-arrow">‚ñº</span>
            </div>
            <div id="competitor-genre-dropdown-content" class="custom-dropdown-content" style="display:none;">
              <input type="text" id="competitor-genre-search" class="dropdown-search" placeholder="–ü–æ–∏—Å–∫ –∂–∞–Ω—Ä–∞..." onkeyup="filterCompetitorGenreOptions()">
              <div id="competitor-genre-options-list" class="dropdown-options"></div>
            </div>
          </div>
          <div id="selected-competitor-genres" class="selected-items"></div>
        </div>
        <button class="btn btn-search" onclick="searchCompetitors()">üîç –ù–∞–π—Ç–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</button>
      </div>
      <div class="competitor-results" id="competitor-results">
        <div class="competitor-results-title">
          –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –Ω–∞ <span id="competitor-date-display"></span> –≤ –≥–æ—Ä–æ–¥–µ <span id="competitor-city-display"></span>
          <span class="count" id="competitor-count">0</span>
        </div>
        <div id="competitor-list"></div>
      </div>
    </div>

    <!-- New Events Section (only for Sales mode) -->
    <div id="new-events-section" class="new-events-section" style="display:none;">
      <div class="new-events-title">
        üÜï –ù–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é
        <span class="count" id="new-events-count">0</span>
      </div>
      <div class="new-events-list" id="new-events-list"></div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="filters-title" onclick="toggleFilters()">
        <span>üîç –§–∏–ª—å—Ç—Ä—ã</span>
        <span id="filters-toggle">‚ñº</span>
      </div>
      <div class="filters-grid" id="filters-grid">
        <div class="filter-group">
          <label>–ü–æ–∏—Å–∫</label>
          <input type="text" id="filter-search" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è..." oninput="debouncedApplyFilters()">
        </div>
        <div class="filter-group">
          <label>–ì–æ—Ä–æ–¥</label>
          <select id="filter-city" onchange="applyFilters()">
            <option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
          </select>
        </div>
        <div class="filter-group">
          <label>–ü–ª–æ—â–∞–¥–∫–∞</label>
          <select id="filter-venue" onchange="applyFilters()" onfocus="loadVenues()">
            <option value="">–í—Å–µ –ø–ª–æ—â–∞–¥–∫–∏</option>
          </select>
        </div>
        <div class="filter-group">
          <label>–ñ–∞–Ω—Ä</label>
          <div class="custom-dropdown-wrapper">
            <div class="custom-dropdown-header" onclick="toggleGenreDropdown()">
              <span id="genre-dropdown-text">–í—Å–µ –∂–∞–Ω—Ä—ã</span>
              <span class="dropdown-arrow">‚ñº</span>
            </div>
            <div id="genre-dropdown-content" class="custom-dropdown-content" style="display:none;">
              <input type="text" id="genre-search" class="dropdown-search" placeholder="–ü–æ–∏—Å–∫ –∂–∞–Ω—Ä–∞..." onkeyup="filterGenreOptions()">
              <div id="genre-options-list" class="dropdown-options"></div>
            </div>
          </div>
          <div id="selected-genres" class="selected-items"></div>
        </div>
        <div class="filter-group">
          <label>–î–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è (–æ—Ç)</label>
          <input type="date" id="filter-date-from" onchange="applyFilters()">
        </div>
        <div class="filter-group">
          <label>–î–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è (–¥–æ)</label>
          <input type="date" id="filter-date-to" onchange="applyFilters()">
        </div>
        <div class="filter-group">
          <label>–î–æ–±–∞–≤–ª–µ–Ω–æ (–æ—Ç)</label>
          <input type="date" id="filter-created-from" onchange="applyFilters()">
        </div>
        <div class="filter-group">
          <label>–î–æ–±–∞–≤–ª–µ–Ω–æ (–¥–æ)</label>
          <input type="date" id="filter-created-to" onchange="applyFilters()">
        </div>
        <div class="filter-group">
          <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</label>
          <select id="filter-comments" onchange="applyFilters()">
            <option value="">–í—Å–µ</option>
            <option value="with">–° –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏</option>
            <option value="without">–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</option>
          </select>
        </div>
      </div>
    </div>

    <div class="btn-group">
      <button class="btn" onclick="fetchData()">‚Üª –û–ë–ù–û–í–ò–¢–¨</button>
      <button class="btn btn-secondary" onclick="clearFilters()">‚úï –°–ë–†–û–° –§–ò–õ–¨–¢–†–û–í</button>
      <button class="btn" onclick="showRecentlyAdded(7)" style="background:#FF6B00;border-color:#CC5500;" id="btn-new-week">üÜï –ù–û–í–´–ï –ó–ê –ù–ï–î–ï–õ–Æ</button>
      <button class="btn btn-secondary" onclick="exportCSV()" style="background:#00CCFF;color:#000;border-color:#0088AA;">üì• –°–ö–ê–ß–ê–¢–¨ CSV</button>
    </div>

    <div id="stats" class="stats"></div>
    <div id="table-container"></div>
  </div>

  <!-- Comment Modal -->
  <div id="comment-modal" class="modal-overlay" onclick="if(event.target===this)closeCommentModal()">
    <div class="modal">
      <h3>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
      <p class="modal-event-title" id="modal-event-title"></p>
      <textarea id="comment-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeCommentModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn-save" id="btn-save-comment" onclick="saveComment()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    // Config
    const SUPABASE_URL = 'https://zffhjnbpbjknclrbcujs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmZmhqbmJwYmprbmNscmJjdWpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExMzIwMTIsImV4cCI6MjA2NjcwODAxMn0.bWXoX_8q89lEFlMCDZ1I2iwUL1CTsU8LNCCn3nO3E3Y';
    const PASSWORD = 'yaarulezz';

    // Tables mapping
    const TABLES = {
      'kz': {
        'sales': 'yaa_events',
        'marketing': 'yaa_events_clean'
      },
      'ru': {
        'sales': 'yaa_events_ru',
        'marketing': 'yaa_events_ru_clean'
      }
    };

    // Currency mapping
    const CURRENCY = {
      'kz': '‚Ç∏',
      'ru': '‚ÇΩ'
    };

    let allData = [];
    let filteredData = [];
    let newEvents = [];
    let selectedRegion = null;
    let selectedPurpose = null;
    let currentTable = null;

    // Debounce –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    let filterTimeout = null;
    function debouncedApplyFilters() {
      clearTimeout(filterTimeout);
      filterTimeout = setTimeout(applyFilters, 300); // 300–º—Å –∑–∞–¥–µ—Ä–∂–∫–∞
    }

    // Auth
    function login() {
      const input = document.getElementById('password-input');
      if (input.value === PASSWORD) {
        sessionStorage.setItem('yaa_auth', 'true');
        showRegionSelection();
      } else {
        document.getElementById('login-error').style.display = 'block';
        input.value = '';
      }
    }

    function logout() {
      sessionStorage.removeItem('yaa_auth');
      sessionStorage.removeItem('yaa_region');
      sessionStorage.removeItem('yaa_purpose');
      selectedRegion = null;
      selectedPurpose = null;
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('region-screen').style.display = 'none';
      document.getElementById('purpose-screen').style.display = 'none';
      document.getElementById('dashboard').classList.remove('active');
    }

    function showRegionSelection() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('region-screen').style.display = 'flex';
      document.getElementById('purpose-screen').style.display = 'none';
      document.getElementById('dashboard').classList.remove('active');

      // Reset selection
      document.querySelectorAll('#region-screen .choice-btn').forEach(b => b.classList.remove('selected'));
      document.getElementById('btn-region-continue').disabled = true;
    }

    function selectRegion(region) {
      selectedRegion = region;
      document.querySelectorAll('#region-screen .choice-btn').forEach(b => b.classList.remove('selected'));
      document.querySelector(`[data-region="${region}"]`).classList.add('selected');
      document.getElementById('btn-region-continue').disabled = false;
    }

    function confirmRegion() {
      if (!selectedRegion) return;
      sessionStorage.setItem('yaa_region', selectedRegion);
      showPurposeSelection();
    }

    function showPurposeSelection() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('region-screen').style.display = 'none';
      document.getElementById('purpose-screen').style.display = 'flex';
      document.getElementById('dashboard').classList.remove('active');

      // Update label
      document.getElementById('purpose-region-label').textContent = selectedRegion.toUpperCase();

      // Reset selection
      document.querySelectorAll('#purpose-screen .choice-btn').forEach(b => b.classList.remove('selected'));
      document.getElementById('btn-purpose-continue').disabled = true;
    }

    function selectPurpose(purpose) {
      selectedPurpose = purpose;
      document.querySelectorAll('#purpose-screen .choice-btn').forEach(b => b.classList.remove('selected'));
      document.querySelector(`[data-purpose="${purpose}"]`).classList.add('selected');
      document.getElementById('btn-purpose-continue').disabled = false;
    }

    function confirmPurpose() {
      if (!selectedPurpose) return;
      sessionStorage.setItem('yaa_purpose', selectedPurpose);
      showDashboard();
    }

    function backToRegion() {
      selectedPurpose = null;
      sessionStorage.removeItem('yaa_purpose');
      showRegionSelection();
    }

    function changeMode() {
      selectedRegion = null;
      selectedPurpose = null;
      sessionStorage.removeItem('yaa_region');
      sessionStorage.removeItem('yaa_purpose');
      showRegionSelection();
    }

    function showDashboard() {
      selectedRegion = sessionStorage.getItem('yaa_region');
      selectedPurpose = sessionStorage.getItem('yaa_purpose');
      currentTable = TABLES[selectedRegion][selectedPurpose];

      // –í–ê–ñ–ù–û: –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞!
      allData = [];
      filteredData = [];
      newEvents = [];

      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('region-screen').style.display = 'none';
      document.getElementById('purpose-screen').style.display = 'none';
      document.getElementById('dashboard').classList.add('active');

      // Update UI
      document.getElementById('dash-region').textContent = selectedRegion.toUpperCase();
      const modeEl = document.getElementById('dash-mode');
      modeEl.textContent = selectedPurpose === 'sales' ? '–ü—Ä–æ–¥–∞–∂–∏' : '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥';
      modeEl.className = 'mode-badge ' + (selectedPurpose === 'sales' ? 'mode-sales' : 'mode-marketing');
      document.getElementById('dash-table-name').textContent = currentTable;

      // Show/hide sections based on mode
      document.getElementById('new-events-section').style.display = selectedPurpose === 'sales' ? 'block' : 'none';
      document.getElementById('competitor-section').style.display = selectedPurpose === 'marketing' ? 'block' : 'none';

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º UI
      document.getElementById('stats').innerHTML = '';
      document.getElementById('table-container').innerHTML = '';

      fetchData();
    }

    function checkAuth() {
      if (sessionStorage.getItem('yaa_auth') === 'true') {
        if (sessionStorage.getItem('yaa_region') && sessionStorage.getItem('yaa_purpose')) {
          showDashboard();
        } else if (sessionStorage.getItem('yaa_region')) {
          selectedRegion = sessionStorage.getItem('yaa_region');
          showPurposeSelection();
        } else {
          showRegionSelection();
        }
      }
    }

    // Data - with pagination to get ALL records
    async function fetchData() {
      const statusEl = document.getElementById('status');
      statusEl.className = 'status loading';
      statusEl.innerHTML = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ ' + currentTable + '...';

      try {
        allData = [];
        const PAGE_SIZE = 1000;
        let offset = 0;
        let hasMore = true;

        while (hasMore) {
          statusEl.innerHTML = `‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞... ${allData.length} –∑–∞–ø–∏—Å–µ–π`;

          const response = await fetch(
            `${SUPABASE_URL}/rest/v1/${currentTable}?select=*&order=date_from.desc`,
            {
              headers: {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json',
                'Range': `${offset}-${offset + PAGE_SIZE - 1}`,
                'Prefer': 'count=exact'
              }
            }
          );

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const batch = await response.json();
          allData = allData.concat(batch);

          // Check if there's more data
          const contentRange = response.headers.get('Content-Range');
          if (contentRange) {
            const match = contentRange.match(/\/(\d+|\*)/);
            const total = match ? parseInt(match[1]) : 0;
            hasMore = allData.length < total;
          } else {
            hasMore = batch.length === PAGE_SIZE;
          }

          offset += PAGE_SIZE;

          // Safety limit
          if (offset > 50000) {
            console.warn('Safety limit reached');
            break;
          }
        }

        // For Sales mode, find new events (created in last 7 days)
        if (selectedPurpose === 'sales') {
          const weekAgo = new Date();
          weekAgo.setDate(weekAgo.getDate() - 7);
          const weekAgoStr = weekAgo.toISOString().substring(0, 10);

          newEvents = allData.filter(e => {
            if (!e.created_at) return false;
            const created = e.created_at.substring(0, 10);
            return created >= weekAgoStr;
          });
          renderNewEvents();
        }

        statusEl.className = 'status success';

        if (allData.length === 0) {
          statusEl.innerHTML = `‚ö†Ô∏è –ó–∞–≥—Ä—É–∂–µ–Ω–æ 0 —Å–æ–±—ã—Ç–∏–π –∏–∑ ${currentTable}. <button onclick="fetchData()" style="background:#00FF88;color:#000;border:2px solid #00AA55;padding:5px 15px;margin-left:10px;cursor:pointer;font-family:inherit;">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>`;
        } else {
          statusEl.innerHTML = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allData.length} —Å–æ–±—ã—Ç–∏–π –∏–∑ ${currentTable}`;
        }

        populateFilters();
        applyFilters();

      } catch (error) {
        console.error('Error:', error);
        statusEl.className = 'status error';
        statusEl.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}. <button onclick="fetchData()" style="background:#ff6666;color:#000;border:2px solid #cc4444;padding:5px 15px;margin-left:10px;cursor:pointer;font-family:inherit;">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>`;
      }
    }

    function renderNewEvents() {
      const countEl = document.getElementById('new-events-count');
      const listEl = document.getElementById('new-events-list');

      countEl.textContent = newEvents.length;

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
      const sortedNew = [...newEvents].sort((a, b) => {
        const dateA = a.created_at || '';
        const dateB = b.created_at || '';
        return dateB.localeCompare(dateA);
      });

      if (sortedNew.length === 0) {
        listEl.innerHTML = '<p style="color:#666;font-size:13px;">–ù–µ—Ç –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é</p>';
        return;
      }

      listEl.innerHTML = sortedNew.slice(0, 15).map(e => {
        const createdDate = e.created_at ? e.created_at.substring(0, 10) : '‚Äî';
        const eventDate = e.date_from || '‚Äî';
        return `
        <div class="new-event-card">
          <div class="new-event-info">
            <div class="new-event-title">${e.url ? `<a href="${e.url}" target="_blank">${escapeHtml(e.title)}</a>` : escapeHtml(e.title)}</div>
            <div class="new-event-meta">${escapeHtml(e.venue) || '‚Äî'} ‚Ä¢ ${translateCity(e.city)}</div>
          </div>
          <div class="new-event-date" style="text-align:right;">
            <div style="color:#00FF88;">üìÖ ${eventDate}</div>
            <div style="color:#888;font-size:9px;">–¥–æ–±–∞–≤–ª–µ–Ω–æ: ${createdDate}</div>
          </div>
        </div>
      `}).join('') + (sortedNew.length > 15 ? `<p style="color:#666;font-size:12px;text-align:center;margin-top:10px;">... –∏ –µ—â—ë ${sortedNew.length - 15} –Ω–æ–≤—ã—Ö</p>` : '');
    }

    let venuesLoaded = false; // –§–ª–∞–≥ –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–æ—â–∞–¥–æ–∫

    function populateFilters() {
      // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π –ø–æ –≥–æ—Ä–æ–¥–∞–º
      const cityCounts = {};
      allData.forEach(e => {
        if (e.city) cityCounts[e.city] = (cityCounts[e.city] || 0) + 1;
      });

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≥–æ—Ä–æ–¥–∞ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–±—ã—Ç–∏–π (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
      const cities = Object.keys(cityCounts).sort((a, b) => cityCounts[b] - cityCounts[a]);

      document.getElementById('filter-city').innerHTML = '<option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞ (' + cities.length + ')</option>' +
        cities.map(c => `<option value="${c}">${translateCity(c)} (${cityCounts[c]})</option>`).join('');

      // –ü–ª–æ—â–∞–¥–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –õ–ï–ù–ò–í–û –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ
      const venueSelect = document.getElementById('filter-venue');
      venuesLoaded = false;
      venueSelect.innerHTML = '<option value="">–í—Å–µ –ø–ª–æ—â–∞–¥–∫–∏ (–∫–ª–∏–∫–Ω–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏)</option>';

      // Populate competitor city dropdown (for Marketing mode)
      if (selectedPurpose === 'marketing') {
        document.getElementById('competitor-city').innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>' +
          cities.map(c => `<option value="${c}">${translateCity(c)} (${cityCounts[c]})</option>`).join('');
        loadCompetitorGenres();
      }

      // Load genres
      loadGenres();
    }

    // –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–ª–æ—â–∞–¥–æ–∫
    function loadVenues() {
      if (venuesLoaded) return;
      venuesLoaded = true;

      const venueCounts = {};
      allData.forEach(e => {
        if (e.venue) venueCounts[e.venue] = (venueCounts[e.venue] || 0) + 1;
      });

      const venues = Object.keys(venueCounts).sort((a, b) => venueCounts[b] - venueCounts[a]);
      const venueSelect = document.getElementById('filter-venue');
      venueSelect.innerHTML = '<option value="">–í—Å–µ –ø–ª–æ—â–∞–¥–∫–∏ (' + venues.length + ')</option>' +
        venues.slice(0, 200).map(v => `<option value="${v}">${v} (${venueCounts[v]})</option>`).join(''); // –õ–∏–º–∏—Ç 200

      if (venues.length > 200) {
        venueSelect.innerHTML += `<option disabled>... –∏ –µ—â—ë ${venues.length - 200} –ø–ª–æ—â–∞–¥–æ–∫</option>`;
      }
    }


    // ========== GENRE FILTER FUNCTIONS ==========
    let selectedGenres = [];
    let genresLoaded = false;

    async function loadGenres() {
      if (genresLoaded) return;
      genresLoaded = true;

      try {
        const genreCounts = {};
        allData.forEach(e => {
          if (e.genre && e.genre.trim()) {
            const genre = e.genre.trim();
            genreCounts[genre] = (genreCounts[genre] || 0) + 1;
          }
        });

        // Sort genres by count (descending), then alphabetically
        const genres = Object.keys(genreCounts).sort((a, b) => {
          const countDiff = genreCounts[b] - genreCounts[a];
          return countDiff !== 0 ? countDiff : a.localeCompare(b);
        });

        const optionsList = document.getElementById('genre-options-list');
        if (optionsList) {
          optionsList.innerHTML = genres.map(g => `
            <div class="dropdown-option" data-genre="${escapeAttr(g)}">
              <span class="dropdown-option-checkbox"></span>
              <span>${escapeHtml(g)} (${genreCounts[g]})</span>
            </div>
          `).join('');

          // Add click handlers using event delegation
          optionsList.querySelectorAll('.dropdown-option').forEach(opt => {
            opt.addEventListener('click', function() {
              const genre = this.getAttribute('data-genre');
              toggleGenreSelection(genre);
            });
          });

          updateGenreDropdownText();
        }

      } catch (error) {
        console.error('Error loading genres:', error);
      }
    }

    function updateSelectedGenres() {
      // This function is kept for backwards compatibility but not used
      // Selection is now handled by toggleGenreSelection()
      updateSelectedGenresDisplay();
      applyFilters();
    }

    function updateSelectedGenresDisplay() {
      const container = document.getElementById('selected-genres');
      container.innerHTML = '';

      selectedGenres.forEach(genre => {
        const tag = document.createElement('div');
        tag.className = 'genre-tag';
        tag.innerHTML = `
          ${escapeHtml(genre)}
          <span class="remove" data-genre="${escapeAttr(genre)}">√ó</span>
        `;
        container.appendChild(tag);
      });

      // Add click handlers for removal
      document.querySelectorAll('.genre-tag .remove').forEach(btn => {
        btn.addEventListener('click', function() {
          const genre = this.getAttribute('data-genre');
          removeGenre(genre);
        });
      });
    }

    function removeGenre(genre) {
      selectedGenres = selectedGenres.filter(g => g !== genre);
      updateSelectedGenresDisplay();
      updateGenreDropdownText();
      applyFilters();
    }

    function applyFilters() {
      const search = document.getElementById('filter-search').value.toLowerCase();
      const city = document.getElementById('filter-city').value;
      const venue = document.getElementById('filter-venue').value;
      const dateFrom = document.getElementById('filter-date-from').value;
      const dateTo = document.getElementById('filter-date-to').value;
      const createdFrom = document.getElementById('filter-created-from').value;
      const createdTo = document.getElementById('filter-created-to').value;
      const commentsFilter = document.getElementById('filter-comments').value;

      filteredData = allData.filter(event => {
        if (search && !event.title?.toLowerCase().includes(search) && !event.venue?.toLowerCase().includes(search)) return false;
        if (city && event.city !== city) return false;
        if (venue && event.venue !== venue) return false;

        // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ —Å–æ–±—ã—Ç–∏—è - —É—á–∏—Ç—ã–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω —Å–æ–±—ã—Ç–∏—è (date_from - date_to)
        // –°–æ–±—ã—Ç–∏–µ –ø–æ–ø–∞–¥–∞–µ—Ç –µ—Å–ª–∏ –µ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º
        if (dateFrom || dateTo) {
          const eventStart = event.date_from;
          const eventEnd = event.date_to || event.date_from; // –µ—Å–ª–∏ –Ω–µ—Ç date_to, –∏—Å–ø–æ–ª—å–∑—É–µ–º date_from

          if (!eventStart) return false; // –Ω–µ—Ç –¥–∞—Ç—ã - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º

          // –°–æ–±—ã—Ç–∏–µ –ù–ï –ø–æ–ø–∞–¥–∞–µ—Ç –µ—Å–ª–∏:
          // - –æ–Ω–æ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –î–û –Ω–∞—á–∞–ª–∞ —Ñ–∏–ª—å—Ç—Ä–∞ (eventEnd < dateFrom)
          // - –æ–Ω–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ü–û–°–õ–ï –∫–æ–Ω—Ü–∞ —Ñ–∏–ª—å—Ç—Ä–∞ (eventStart > dateTo)
          if (dateFrom && eventEnd && eventEnd < dateFrom) return false;
          if (dateTo && eventStart > dateTo) return false;
        }

        if (createdFrom && event.created_at) {
          if (event.created_at.substring(0, 10) < createdFrom) return false;
        }
        if (createdTo && event.created_at) {
          if (event.created_at.substring(0, 10) > createdTo) return false;
        }
        if (commentsFilter === 'with' && (!event.comments || !event.comments.trim())) return false;
        if (commentsFilter === 'without' && event.comments && event.comments.trim()) return false;

        // Genre filter (multi-select)
        if (selectedGenres.length > 0) {
          if (!event.genre || !selectedGenres.includes(event.genre.trim())) return false;
        }

        return true;
      });

      renderStats();
      renderTable();
    }

    function clearFilters() {
      ['filter-search', 'filter-city', 'filter-venue', 'filter-genre', 'filter-date-from', 'filter-date-to', 'filter-created-from', 'filter-created-to', 'filter-comments']
        .forEach(id => document.getElementById(id).value = '');
      selectedGenres = [];
      updateSelectedGenresDisplay();
      genresLoaded = false;
      applyFilters();
    }

    function toggleFilters() {
      const grid = document.getElementById('filters-grid');
      const toggle = document.getElementById('filters-toggle');
      if (grid.style.display === 'none') {
        grid.style.display = 'grid';
        toggle.textContent = '‚ñº';
      } else {
        grid.style.display = 'none';
        toggle.textContent = '‚ñ∂';
      }
    }

    // Get price - divide by 100 for RU (data in kopeks)
    function getPrice(price) {
      const rawPrice = parseFloat(price) || 0;
      // RU prices are in kopeks, divide by 100
      if (selectedRegion === 'ru') {
        return Math.round(rawPrice / 100);
      }
      return rawPrice;
    }

    // –ü–µ—Ä–µ–≤–æ–¥ –≥–æ—Ä–æ–¥–æ–≤ –Ω–∞ —Ä—É—Å—Å–∫–∏–π
    const CITY_TO_RUSSIAN = {
      'moscow': '–ú–æ—Å–∫–≤–∞', 'Moscow': '–ú–æ—Å–∫–≤–∞',
      'saint petersburg': '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', 'Saint Petersburg': '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', 'St. Petersburg': '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', 'St Petersburg': '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
      'yekaterinburg': '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', 'Yekaterinburg': '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', 'Ekaterinburg': '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥',
      'novosibirsk': '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', 'Novosibirsk': '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫',
      'kazan': '–ö–∞–∑–∞–Ω—å', 'Kazan': '–ö–∞–∑–∞–Ω—å',
      'nizhny novgorod': '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥', 'Nizhny Novgorod': '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥',
      'samara': '–°–∞–º–∞—Ä–∞', 'Samara': '–°–∞–º–∞—Ä–∞',
      'rostov-on-don': '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É', 'Rostov-on-Don': '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É', 'Rostov': '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É',
      'krasnodar': '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä', 'Krasnodar': '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä',
      'sochi': '–°–æ—á–∏', 'Sochi': '–°–æ—á–∏',
      'voronezh': '–í–æ—Ä–æ–Ω–µ–∂', 'Voronezh': '–í–æ—Ä–æ–Ω–µ–∂',
      'ufa': '–£—Ñ–∞', 'Ufa': '–£—Ñ–∞',
      'krasnoyarsk': '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫', 'Krasnoyarsk': '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫',
      'perm': '–ü–µ—Ä–º—å', 'Perm': '–ü–µ—Ä–º—å',
      'volgograd': '–í–æ–ª–≥–æ–≥—Ä–∞–¥', 'Volgograd': '–í–æ–ª–≥–æ–≥—Ä–∞–¥',
      'saratov': '–°–∞—Ä–∞—Ç–æ–≤', 'Saratov': '–°–∞—Ä–∞—Ç–æ–≤',
      'tyumen': '–¢—é–º–µ–Ω—å', 'Tyumen': '–¢—é–º–µ–Ω—å',
      'chelyabinsk': '–ß–µ–ª—è–±–∏–Ω—Å–∫', 'Chelyabinsk': '–ß–µ–ª—è–±–∏–Ω—Å–∫',
      'omsk': '–û–º—Å–∫', 'Omsk': '–û–º—Å–∫',
      'kaliningrad': '–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥', 'Kaliningrad': '–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥',
      'vladivostok': '–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫', 'Vladivostok': '–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫',
      'irkutsk': '–ò—Ä–∫—É—Ç—Å–∫', 'Irkutsk': '–ò—Ä–∫—É—Ç—Å–∫',
      'khabarovsk': '–•–∞–±–∞—Ä–æ–≤—Å–∫', 'Khabarovsk': '–•–∞–±–∞—Ä–æ–≤—Å–∫',
      'tomsk': '–¢–æ–º—Å–∫', 'Tomsk': '–¢–æ–º—Å–∫',
      'kemerovo': '–ö–µ–º–µ—Ä–æ–≤–æ', 'Kemerovo': '–ö–µ–º–µ—Ä–æ–≤–æ',
      'barnaul': '–ë–∞—Ä–Ω–∞—É–ª', 'Barnaul': '–ë–∞—Ä–Ω–∞—É–ª',
      'ryazan': '–†—è–∑–∞–Ω—å', 'Ryazan': '–†—è–∑–∞–Ω—å',
      'tula': '–¢—É–ª–∞', 'Tula': '–¢—É–ª–∞',
      'yaroslavl': '–Ø—Ä–æ—Å–ª–∞–≤–ª—å', 'Yaroslavl': '–Ø—Ä–æ—Å–ª–∞–≤–ª—å',
      'orenburg': '–û—Ä–µ–Ω–±—É—Ä–≥', 'Orenburg': '–û—Ä–µ–Ω–±—É—Ä–≥',
      'penza': '–ü–µ–Ω–∑–∞', 'Penza': '–ü–µ–Ω–∑–∞',
      'lipetsk': '–õ–∏–ø–µ—Ü–∫', 'Lipetsk': '–õ–∏–ø–µ—Ü–∫',
      'naberezhnye chelny': '–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã', 'Naberezhnye Chelny': '–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã',
      'tolyatti': '–¢–æ–ª—å—è—Ç—Ç–∏', 'Tolyatti': '–¢–æ–ª—å—è—Ç—Ç–∏',
      'izhevsk': '–ò–∂–µ–≤—Å–∫', 'Izhevsk': '–ò–∂–µ–≤—Å–∫',
      'ulyanovsk': '–£–ª—å—è–Ω–æ–≤—Å–∫', 'Ulyanovsk': '–£–ª—å—è–Ω–æ–≤—Å–∫',
      'makhachkala': '–ú–∞—Ö–∞—á–∫–∞–ª–∞', 'Makhachkala': '–ú–∞—Ö–∞—á–∫–∞–ª–∞',
      'stavropol': '–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å', 'Stavropol': '–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å',
      'bryansk': '–ë—Ä—è–Ω—Å–∫', 'Bryansk': '–ë—Ä—è–Ω—Å–∫',
      'tver': '–¢–≤–µ—Ä—å', 'Tver': '–¢–≤–µ—Ä—å',
      'kursk': '–ö—É—Ä—Å–∫', 'Kursk': '–ö—É—Ä—Å–∫',
      'magnitogorsk': '–ú–∞–≥–Ω–∏—Ç–æ–≥–æ—Ä—Å–∫', 'Magnitogorsk': '–ú–∞–≥–Ω–∏—Ç–æ–≥–æ—Ä—Å–∫',
      'surgut': '–°—É—Ä–≥—É—Ç', 'Surgut': '–°—É—Ä–≥—É—Ç',
      'vladimir': '–í–ª–∞–¥–∏–º–∏—Ä', 'Vladimir': '–í–ª–∞–¥–∏–º–∏—Ä',
      'chita': '–ß–∏—Ç–∞', 'Chita': '–ß–∏—Ç–∞',
      'arkhangelsk': '–ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫', 'Arkhangelsk': '–ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫',
      'belgorod': '–ë–µ–ª–≥–æ—Ä–æ–¥', 'Belgorod': '–ë–µ–ª–≥–æ—Ä–æ–¥',
      'kaluga': '–ö–∞–ª—É–≥–∞', 'Kaluga': '–ö–∞–ª—É–≥–∞',
      'smolensk': '–°–º–æ–ª–µ–Ω—Å–∫', 'Smolensk': '–°–º–æ–ª–µ–Ω—Å–∫',
      'murmansk': '–ú—É—Ä–º–∞–Ω—Å–∫', 'Murmansk': '–ú—É—Ä–º–∞–Ω—Å–∫',
      // Kazakhstan
      'almaty': '–ê–ª–º–∞—Ç—ã', 'Almaty': '–ê–ª–º–∞—Ç—ã',
      'astana': '–ê—Å—Ç–∞–Ω–∞', 'Astana': '–ê—Å—Ç–∞–Ω–∞', 'Nur-Sultan': '–ê—Å—Ç–∞–Ω–∞',
      'shymkent': '–®—ã–º–∫–µ–Ω—Ç', 'Shymkent': '–®—ã–º–∫–µ–Ω—Ç',
      'karaganda': '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞', 'Karaganda': '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞', 'Karagandy': '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞',
      'aktobe': '–ê–∫—Ç–æ–±–µ', 'Aktobe': '–ê–∫—Ç–æ–±–µ',
      'taraz': '–¢–∞—Ä–∞–∑', 'Taraz': '–¢–∞—Ä–∞–∑',
      'pavlodar': '–ü–∞–≤–ª–æ–¥–∞—Ä', 'Pavlodar': '–ü–∞–≤–ª–æ–¥–∞—Ä',
      'semey': '–°–µ–º–µ–π', 'Semey': '–°–µ–º–µ–π',
      'atyrau': '–ê—Ç—ã—Ä–∞—É', 'Atyrau': '–ê—Ç—ã—Ä–∞—É',
      'kostanay': '–ö–æ—Å—Ç–∞–Ω–∞–π', 'Kostanay': '–ö–æ—Å—Ç–∞–Ω–∞–π',
      'kyzylorda': '–ö—ã–∑—ã–ª–æ—Ä–¥–∞', 'Kyzylorda': '–ö—ã–∑—ã–ª–æ—Ä–¥–∞',
      'aktau': '–ê–∫—Ç–∞—É', 'Aktau': '–ê–∫—Ç–∞—É',
      'uralsk': '–£—Ä–∞–ª—å—Å–∫', 'Uralsk': '–£—Ä–∞–ª—å—Å–∫', 'Oral': '–£—Ä–∞–ª—å—Å–∫',
      'petropavlovsk': '–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫', 'Petropavlovsk': '–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫',
    };

    function translateCity(city) {
      if (!city) return '‚Äî';
      return CITY_TO_RUSSIAN[city] || CITY_TO_RUSSIAN[city.toLowerCase()] || city;
    }

    function renderStats() {
      const total = filteredData.length;
      const avgPrice = total > 0 ? Math.round(filteredData.reduce((sum, e) => sum + getPrice(e.price), 0) / total) : 0;
      const cities = new Set(filteredData.map(e => e.city).filter(Boolean)).size;
      const venues = new Set(filteredData.map(e => e.venue).filter(Boolean)).size;
      const currency = CURRENCY[selectedRegion];

      document.getElementById('stats').innerHTML = `
        <div class="stat-card"><div class="stat-label">–°–æ–±—ã—Ç–∏–π</div><div class="stat-value">${total}</div></div>
        <div class="stat-card"><div class="stat-label">–°—Ä. —Ü–µ–Ω–∞</div><div class="stat-value">${avgPrice.toLocaleString()} ${currency}</div></div>
        <div class="stat-card"><div class="stat-label">–ì–æ—Ä–æ–¥–æ–≤</div><div class="stat-value">${cities}</div></div>
        <div class="stat-card"><div class="stat-label">–ü–ª–æ—â–∞–¥–æ–∫</div><div class="stat-value">${venues}</div></div>
      `;
    }

    // ========== –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã ==========
    const TABLE_PAGE_SIZE = 100; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ 100 –∑–∞–ø–∏—Å–µ–π
    let currentTablePage = 0;
    let isLoadingMore = false;

    function renderTable() {
      const tableEl = document.getElementById('table-container');
      const currency = CURRENCY[selectedRegion];
      currentTablePage = 0; // –°–±—Ä–æ—Å –ø—Ä–∏ –Ω–æ–≤–æ–º —Ä–µ–Ω–¥–µ—Ä–µ

      if (filteredData.length === 0) {
        tableEl.innerHTML = '<p class="results-info">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º</p>';
        return;
      }

      // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ TABLE_PAGE_SIZE –∑–∞–ø–∏—Å–µ–π
      const visibleData = filteredData.slice(0, TABLE_PAGE_SIZE);
      const rows = renderRows(visibleData, currency);

      tableEl.innerHTML = `
        <div class="table-container" id="table-scroll-container">
          <table>
            <thead><tr>
              <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ü–ª–æ—â–∞–¥–∫–∞</th><th>–ì–æ—Ä–æ–¥</th><th>–ñ–∞–Ω—Ä</th><th>–î–∞—Ç–∞ —Å</th><th>–î–∞—Ç–∞ –ø–æ</th><th>–î–æ–±–∞–≤–ª–µ–Ω–æ</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th style="text-align:right">–¶–µ–Ω–∞</th>
            </tr></thead>
            <tbody id="table-body">${rows}</tbody>
          </table>
        </div>
        <p class="results-info">
          –ü–æ–∫–∞–∑–∞–Ω–æ <span id="shown-count">${Math.min(TABLE_PAGE_SIZE, filteredData.length)}</span> –∏–∑ ${filteredData.length} —Å–æ–±—ã—Ç–∏–π
          ${filteredData.length > TABLE_PAGE_SIZE ? `<button onclick="loadMoreRows()" id="load-more-btn" style="background:#00FF88;color:#000;border:2px solid #00AA55;padding:5px 15px;margin-left:10px;cursor:pointer;font-family:inherit;">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë ${Math.min(TABLE_PAGE_SIZE, filteredData.length - TABLE_PAGE_SIZE)}</button>` : ''}
        </p>
      `;

      // –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Å–∫—Ä–æ–ª–ª
      const scrollContainer = document.getElementById('table-scroll-container');
      if (scrollContainer) {
        scrollContainer.addEventListener('scroll', handleTableScroll);
      }
    }

    // –§–ª–∞–≥ —Ä–µ–∂–∏–º–∞ "–Ω–æ–≤—ã–µ"
    let showingRecentMode = false;
    let recentCutoffDate = null;

    function renderRows(data, currency) {
      return data.map(event => {
        const createdDate = event.created_at ? event.created_at.substring(0, 10) : '‚Äî';
        const hasComment = event.comments && event.comments.trim();
        const commentClass = hasComment ? 'has-comment' : 'empty';
        const commentText = hasComment ? escapeHtml(event.comments) : '+ –¥–æ–±–∞–≤–∏—Ç—å';
        const dateFrom = event.date_from || '‚Äî';
        const dateTo = event.date_to && event.date_to !== event.date_from ? event.date_to : '‚Äî';

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ "–Ω–æ–≤—ã–µ"
        const isNew = showingRecentMode && recentCutoffDate && createdDate >= recentCutoffDate;
        const rowStyle = isNew ? ' style="background:rgba(0,255,136,0.1);"' : '';
        const createdStyle = isNew ? 'color:#00FF88;font-weight:bold;' : '';

        return `
          <tr${rowStyle}>
            <td>${event.url ? `<a href="${event.url}" target="_blank">${escapeHtml(event.title) || '‚Äî'}</a>` : (escapeHtml(event.title) || '‚Äî')}</td>
            <td>${escapeHtml(event.venue) || '‚Äî'}</td>
            <td>${translateCity(event.city)}</td>
            <td class="date-cell">${dateFrom}</td>
            <td class="date-cell">${dateTo}</td>
            <td class="date-cell" style="${createdStyle}">${createdDate}</td>
            <td class="comment-cell">
              <span class="comment-text ${commentClass}" data-id="${event.id}" data-url="${escapeAttr(event.url)}" data-title="${escapeAttr(event.title)}" data-comment="${escapeAttr(event.comments)}">${commentText}</span>
            </td>
            <td class="price-cell">${getPrice(event.price).toLocaleString()} ${currency}</td>
          </tr>
        `;
      }).join('');
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–¥–∞–≤–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
    function showRecentlyAdded(days) {
      showingRecentMode = true;

      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);
      recentCutoffDate = cutoff.toISOString().substring(0, 10);

      // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
      const recentEvents = allData.filter(e => {
        if (!e.created_at) return false;
        return e.created_at.substring(0, 10) >= recentCutoffDate;
      });

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
      recentEvents.sort((a, b) => {
        const dateA = a.created_at || '';
        const dateB = b.created_at || '';
        return dateB.localeCompare(dateA);
      });

      filteredData = recentEvents;
      renderStats();
      renderTable();

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
      const statusEl = document.getElementById('status');
      statusEl.className = 'status success';
      statusEl.innerHTML = `üÜï –ü–æ–∫–∞–∑–∞–Ω–æ ${recentEvents.length} —Å–æ–±—ã—Ç–∏–π, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ ${days} –¥–Ω–µ–π <button onclick="clearRecentMode()" style="background:#333;color:#fff;border:2px solid #555;padding:5px 15px;margin-left:10px;cursor:pointer;font-family:inherit;">‚úï –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>`;
    }

    // –°–±—Ä–æ—Å —Ä–µ–∂–∏–º–∞ "–Ω–æ–≤—ã–µ"
    function clearRecentMode() {
      showingRecentMode = false;
      recentCutoffDate = null;
      applyFilters();
      const statusEl = document.getElementById('status');
      statusEl.innerHTML = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allData.length} —Å–æ–±—ã—Ç–∏–π –∏–∑ ${currentTable}`;
    }

    // –ü–æ–¥–≥—Ä—É–∑–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Ç—Ä–æ–∫
    function loadMoreRows() {
      if (isLoadingMore) return;
      isLoadingMore = true;

      currentTablePage++;
      const startIdx = currentTablePage * TABLE_PAGE_SIZE;
      const endIdx = startIdx + TABLE_PAGE_SIZE;
      const newData = filteredData.slice(startIdx, endIdx);

      if (newData.length === 0) {
        isLoadingMore = false;
        return;
      }

      const currency = CURRENCY[selectedRegion];
      const newRows = renderRows(newData, currency);

      const tbody = document.getElementById('table-body');
      if (tbody) {
        tbody.insertAdjacentHTML('beforeend', newRows);
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫
      const shownCount = document.getElementById('shown-count');
      const loadMoreBtn = document.getElementById('load-more-btn');
      const totalShown = Math.min((currentTablePage + 1) * TABLE_PAGE_SIZE, filteredData.length);

      if (shownCount) shownCount.textContent = totalShown;

      if (loadMoreBtn) {
        const remaining = filteredData.length - totalShown;
        if (remaining <= 0) {
          loadMoreBtn.style.display = 'none';
        } else {
          loadMoreBtn.textContent = `–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë ${Math.min(TABLE_PAGE_SIZE, remaining)}`;
        }
      }

      isLoadingMore = false;
    }

    // –ê–≤—Ç–æ–ø–æ–¥–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
    function handleTableScroll(e) {
      const container = e.target;
      const scrollBottom = container.scrollHeight - container.scrollTop - container.clientHeight;

      if (scrollBottom < 200 && !isLoadingMore) {
        loadMoreRows();
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function escapeAttr(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // Competitor Search (Marketing mode)

    // ========== COMPETITOR GENRE FILTER ==========
    let selectedCompetitorGenres = [];

    function updateCompetitorGenres() {
      // This function is kept for backwards compatibility but not used
      // Selection is now handled by toggleCompetitorGenreSelection()
      updateCompetitorGenresDisplay();
    }

    function updateCompetitorGenresDisplay() {
      const container = document.getElementById('selected-competitor-genres');
      container.innerHTML = '';

      selectedCompetitorGenres.forEach(genre => {
        const tag = document.createElement('div');
        tag.className = 'genre-tag';
        tag.innerHTML = `
          ${escapeHtml(genre)}
          <span class="remove" data-genre="${escapeAttr(genre)}">√ó</span>
        `;
        container.appendChild(tag);
      });

      // Add click handlers for removal
      document.querySelectorAll('#selected-competitor-genres .remove').forEach(btn => {
        btn.addEventListener('click', function() {
          const genre = this.getAttribute('data-genre');
          removeCompetitorGenre(genre);
        });
      });
    }

    function removeCompetitorGenre(genre) {
      selectedCompetitorGenres = selectedCompetitorGenres.filter(g => g !== genre);
      updateCompetitorGenresDisplay();
      updateCompetitorGenreDropdownText();
    }

    function loadCompetitorGenres() {
      try {
        const genreCounts = {};
        allData.forEach(e => {
          if (e.genre && e.genre.trim()) {
            const genre = e.genre.trim();
            genreCounts[genre] = (genreCounts[genre] || 0) + 1;
          }
        });

        const genres = Object.keys(genreCounts).sort((a, b) => {
          const countDiff = genreCounts[b] - genreCounts[a];
          return countDiff !== 0 ? countDiff : a.localeCompare(b);
        });

        const optionsList = document.getElementById('competitor-genre-options-list');
        if (optionsList) {
          optionsList.innerHTML = genres.map(g => `
            <div class="dropdown-option" data-genre="${escapeAttr(g)}">
              <span class="dropdown-option-checkbox"></span>
              <span>${escapeHtml(g)} (${genreCounts[g]})</span>
            </div>
          `).join('');

          // Add click handlers using event delegation
          optionsList.querySelectorAll('.dropdown-option').forEach(opt => {
            opt.addEventListener('click', function() {
              const genre = this.getAttribute('data-genre');
              toggleCompetitorGenreSelection(genre);
            });
          });

          updateCompetitorGenreDropdownText();
        }

      } catch (error) {
        console.error('Error loading competitor genres:', error);
      }
    }

    function searchCompetitors() {
      const targetDate = document.getElementById('competitor-date').value;
      const targetCity = document.getElementById('competitor-city').value;

      if (!targetDate) {
        alert('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É —Å–æ–±—ã—Ç–∏—è');
        return;
      }
      if (!targetCity) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥');
        return;
      }

      const currency = CURRENCY[selectedRegion];

      // Find competitors: events in same city that overlap with target date
      // Event matches if:
      // 1. date_from equals target date, OR
      // 2. target date falls between date_from and date_to (for shows with date ranges)
      const competitors = allData.filter(e => {
        if (e.city !== targetCity) return false;

        const dateFrom = e.date_from;
        const dateTo = e.date_to || e.date_from; // If no date_to, use date_from

        if (!dateFrom) return false;

        // Check if target date falls within event's date range
        return targetDate >= dateFrom && targetDate <= dateTo;
      });

      // Display results
      document.getElementById('competitor-date-display').textContent = targetDate;
      document.getElementById('competitor-city-display').textContent = targetCity;
      document.getElementById('competitor-count').textContent = competitors.length;

      const listEl = document.getElementById('competitor-list');

      if (competitors.length === 0) {
        listEl.innerHTML = '<p style="color:#666;font-size:13px;padding:10px 0;">üéâ –û—Ç–ª–∏—á–Ω–æ! –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É –≤ —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ.</p>';
      } else {
        listEl.innerHTML = competitors.map(e => {
          const dateRange = e.date_to && e.date_to !== e.date_from
            ? `${e.date_from} ‚Äî ${e.date_to}`
            : e.date_from;
          return `
            <div class="competitor-card">
              <div class="competitor-info">
                <div class="competitor-event-title">${e.url ? `<a href="${e.url}" target="_blank">${escapeHtml(e.title)}</a>` : escapeHtml(e.title)}</div>
                <div class="competitor-meta">${escapeHtml(e.venue) || '‚Äî'}</div>
              </div>
              <div class="competitor-dates">
                <div>${dateRange}</div>
                <div class="competitor-price">${getPrice(e.price).toLocaleString()} ${currency}</div>
              </div>
            </div>
          `;
        }).join('');
      }

      document.getElementById('competitor-results').classList.add('active');
    }

    // Comment Modal
    let currentEditId = null;
    let currentEditUrl = null;

    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('comment-text')) {
        currentEditId = e.target.dataset.id;
        currentEditUrl = e.target.dataset.url || '';
        document.getElementById('modal-event-title').textContent = e.target.dataset.title || '–°–æ–±—ã—Ç–∏–µ';
        document.getElementById('comment-input').value = e.target.dataset.comment || '';
        document.getElementById('comment-modal').classList.add('active');
        document.getElementById('comment-input').focus();
      }
    });

    function closeCommentModal() {
      document.getElementById('comment-modal').classList.remove('active');
      currentEditId = null;
      currentEditUrl = null;
    }

    async function saveComment() {
      if (!currentEditId) return;

      const comment = document.getElementById('comment-input').value;
      const saveBtn = document.getElementById('btn-save-comment');
      saveBtn.disabled = true;
      saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

      try {
        const filterParam = currentEditUrl ? `url=eq.${encodeURIComponent(currentEditUrl)}` : `id=eq.${currentEditId}`;
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/${currentTable}?${filterParam}`,
          {
            method: 'PATCH',
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=representation'
            },
            body: JSON.stringify({ comments: comment })
          }
        );

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const eventIndex = currentEditUrl
          ? allData.findIndex(e => e.url === currentEditUrl)
          : allData.findIndex(e => e.id === currentEditId);
        if (eventIndex !== -1) allData[eventIndex].comments = comment;

        closeCommentModal();
        applyFilters();

        document.getElementById('status').innerHTML = '‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Ö—Ä–∞–Ω—ë–Ω';
        setTimeout(() => {
          document.getElementById('status').innerHTML = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allData.length} —Å–æ–±—ã—Ç–∏–π –∏–∑ ${currentTable}`;
        }, 2000);

      } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      }
    }

    // AI Search - natural language query parser with city/category mapping

    // City name mappings (Russian ‚Üí possible DB values)
    // –í–ê–ñ–ù–û: –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–µ/—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å—Å—è –ø–µ—Ä–≤—ã–º–∏!
    const CITY_ALIASES = [
      // –î–ª–∏–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–µ—Ä–≤—ã–º–∏ (—á—Ç–æ–±—ã "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥" –ø—Ä–æ–≤–µ—Ä—è–ª—Å—è —Ä–∞–Ω—å—à–µ "–ø–µ—Ç–µ—Ä–±—É—Ä–≥")
      { patterns: ['—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥', '—Å–∞–Ω–∫—Ç –ø–µ—Ç–µ—Ä–±—É—Ä–≥', 'saint petersburg', 'st. petersburg', 'st petersburg'], dbNames: ['Saint Petersburg', 'St. Petersburg', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '–°–ü–±', 'Saint-Petersburg', 'St Petersburg'] },
      { patterns: ['–Ω–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥', 'nizhny novgorod'], dbNames: ['Nizhny Novgorod', '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥'] },
      { patterns: ['—Ä–æ—Å—Ç–æ–≤-–Ω–∞-–¥–æ–Ω—É', '—Ä–æ—Å—Ç–æ–≤ –Ω–∞ –¥–æ–Ω—É', 'rostov-on-don'], dbNames: ['Rostov-on-Don', '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É', 'Rostov'] },
      { patterns: ['–Ω—É—Ä-—Å—É–ª—Ç–∞–Ω', '–Ω—É—Ä —Å—É–ª—Ç–∞–Ω', 'nur-sultan'], dbNames: ['Astana', '–ê—Å—Ç–∞–Ω–∞', 'Nur-Sultan', '–ù—É—Ä-–°—É–ª—Ç–∞–Ω'] },
      { patterns: ['—É—Å—Ç—å-–∫–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫', '—É—Å—Ç—å –∫–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫', 'ust-kamenogorsk'], dbNames: ['Ust-Kamenogorsk', '–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫'] },

      // –†–æ—Å—Å–∏—è - –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–ª—ç–Ω–≥–æ–≤—ã–µ
      { patterns: ['–º—Å–∫', '–≤ –º—Å–∫'], dbNames: ['Moscow', '–ú–æ—Å–∫–≤–∞', '–º–æ—Å–∫–≤–∞', 'MOSCOW'] },
      { patterns: ['—Å–ø–±', '–≤ —Å–ø–±'], dbNames: ['Saint Petersburg', 'St. Petersburg', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '–°–ü–±', 'Saint-Petersburg', 'St Petersburg'] },
      { patterns: ['–µ–∫–±', '–≤ –µ–∫–±'], dbNames: ['Yekaterinburg', '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', 'Ekaterinburg'] },
      { patterns: ['–Ω—Å–∫', '–≤ –Ω—Å–∫'], dbNames: ['Novosibirsk', '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫'] },

      // –†–æ—Å—Å–∏—è - –ø–æ–ª–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
      { patterns: ['–º–æ—Å–∫–≤–∞', '–º–æ—Å–∫–≤–µ', '–º–æ—Å–∫–≤—É', 'moscow'], dbNames: ['Moscow', '–ú–æ—Å–∫–≤–∞', '–º–æ—Å–∫–≤–∞', 'MOSCOW'] },
      { patterns: ['–ø–∏—Ç–µ—Ä', '–ø–∏—Ç–µ—Ä–µ', '–ø–µ—Ç–µ—Ä–±—É—Ä–≥', '–ø–µ—Ç–µ—Ä–±—É—Ä–≥–µ'], dbNames: ['Saint Petersburg', 'St. Petersburg', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', '–°–ü–±', 'Saint-Petersburg', 'St Petersburg'] },
      { patterns: ['–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–µ', 'yekaterinburg', 'ekaterinburg'], dbNames: ['Yekaterinburg', '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', 'Ekaterinburg'] },
      { patterns: ['–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–µ', 'novosibirsk'], dbNames: ['Novosibirsk', '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫'] },
      { patterns: ['–∫–∞–∑–∞–Ω—å', '–∫–∞–∑–∞–Ω–∏', 'kazan'], dbNames: ['Kazan', '–ö–∞–∑–∞–Ω—å'] },
      { patterns: ['–Ω–∏–∂–Ω–∏–π', '–Ω–∏–∂–Ω–µ–º'], dbNames: ['Nizhny Novgorod', '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥'] },
      { patterns: ['—Å–∞–º–∞—Ä–∞', '—Å–∞–º–∞—Ä–µ', 'samara'], dbNames: ['Samara', '–°–∞–º–∞—Ä–∞'] },
      { patterns: ['—Ä–æ—Å—Ç–æ–≤', '—Ä–æ—Å—Ç–æ–≤–µ'], dbNames: ['Rostov-on-Don', '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É', 'Rostov'] },
      { patterns: ['–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä', '–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ', 'krasnodar'], dbNames: ['Krasnodar', '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä'] },
      { patterns: ['—Å–æ—á–∏', 'sochi'], dbNames: ['Sochi', '–°–æ—á–∏'] },
      { patterns: ['–≤–æ—Ä–æ–Ω–µ–∂', '–≤–æ—Ä–æ–Ω–µ–∂–µ', 'voronezh'], dbNames: ['Voronezh', '–í–æ—Ä–æ–Ω–µ–∂'] },
      { patterns: ['—É—Ñ–∞', '—É—Ñ–µ', 'ufa'], dbNames: ['Ufa', '–£—Ñ–∞'] },
      { patterns: ['–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫', '–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–µ', 'krasnoyarsk'], dbNames: ['Krasnoyarsk', '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫'] },
      { patterns: ['–ø–µ—Ä–º—å', '–ø–µ—Ä–º–∏', 'perm'], dbNames: ['Perm', '–ü–µ—Ä–º—å'] },
      { patterns: ['–≤–æ–ª–≥–æ–≥—Ä–∞–¥', '–≤–æ–ª–≥–æ–≥—Ä–∞–¥–µ', 'volgograd'], dbNames: ['Volgograd', '–í–æ–ª–≥–æ–≥—Ä–∞–¥'] },
      { patterns: ['—Å–∞—Ä–∞—Ç–æ–≤', '—Å–∞—Ä–∞—Ç–æ–≤–µ', 'saratov'], dbNames: ['Saratov', '–°–∞—Ä–∞—Ç–æ–≤'] },
      { patterns: ['—Ç—é–º–µ–Ω—å', '—Ç—é–º–µ–Ω–∏', 'tyumen'], dbNames: ['Tyumen', '–¢—é–º–µ–Ω—å'] },
      { patterns: ['—á–µ–ª—è–±–∏–Ω—Å–∫', '—á–µ–ª—è–±–∏–Ω—Å–∫–µ', 'chelyabinsk'], dbNames: ['Chelyabinsk', '–ß–µ–ª—è–±–∏–Ω—Å–∫'] },
      { patterns: ['–æ–º—Å–∫', '–æ–º—Å–∫–µ', 'omsk'], dbNames: ['Omsk', '–û–º—Å–∫'] },
      { patterns: ['–∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥', '–∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥–µ', 'kaliningrad'], dbNames: ['Kaliningrad', '–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥'] },
      { patterns: ['–≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫', '–≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫–µ', 'vladivostok'], dbNames: ['Vladivostok', '–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫'] },
      { patterns: ['–∏—Ä–∫—É—Ç—Å–∫', '–∏—Ä–∫—É—Ç—Å–∫–µ', 'irkutsk'], dbNames: ['Irkutsk', '–ò—Ä–∫—É—Ç—Å–∫'] },
      { patterns: ['—Ö–∞–±–∞—Ä–æ–≤—Å–∫', '—Ö–∞–±–∞—Ä–æ–≤—Å–∫–µ', 'khabarovsk'], dbNames: ['Khabarovsk', '–•–∞–±–∞—Ä–æ–≤—Å–∫'] },
      { patterns: ['—Ç–æ–º—Å–∫', '—Ç–æ–º—Å–∫–µ', 'tomsk'], dbNames: ['Tomsk', '–¢–æ–º—Å–∫'] },
      { patterns: ['–∫–µ–º–µ—Ä–æ–≤–æ', 'kemerovo'], dbNames: ['Kemerovo', '–ö–µ–º–µ—Ä–æ–≤–æ'] },
      { patterns: ['–±–∞—Ä–Ω–∞—É–ª', '–±–∞—Ä–Ω–∞—É–ª–µ', 'barnaul'], dbNames: ['Barnaul', '–ë–∞—Ä–Ω–∞—É–ª'] },
      { patterns: ['—Ä—è–∑–∞–Ω—å', '—Ä—è–∑–∞–Ω–∏', 'ryazan'], dbNames: ['Ryazan', '–†—è–∑–∞–Ω—å'] },
      { patterns: ['—Ç—É–ª–∞', '—Ç—É–ª–µ', 'tula'], dbNames: ['Tula', '–¢—É–ª–∞'] },
      { patterns: ['—è—Ä–æ—Å–ª–∞–≤–ª—å', '—è—Ä–æ—Å–ª–∞–≤–ª–µ', 'yaroslavl'], dbNames: ['Yaroslavl', '–Ø—Ä–æ—Å–ª–∞–≤–ª—å'] },
      { patterns: ['–æ—Ä–µ–Ω–±—É—Ä–≥', '–æ—Ä–µ–Ω–±—É—Ä–≥–µ', 'orenburg'], dbNames: ['Orenburg', '–û—Ä–µ–Ω–±—É—Ä–≥'] },
      { patterns: ['–ø–µ–Ω–∑–∞', '–ø–µ–Ω–∑–µ', 'penza'], dbNames: ['Penza', '–ü–µ–Ω–∑–∞'] },
      { patterns: ['–ª–∏–ø–µ—Ü–∫', '–ª–∏–ø–µ—Ü–∫–µ', 'lipetsk'], dbNames: ['Lipetsk', '–õ–∏–ø–µ—Ü–∫'] },
      { patterns: ['–Ω–∞–±–µ—Ä–µ–∂–Ω—ã–µ —á–µ–ª–Ω—ã', '–Ω–∞–±–µ—Ä–µ–∂–Ω—ã—Ö —á–µ–ª–Ω–∞—Ö'], dbNames: ['Naberezhnye Chelny', '–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ –ß–µ–ª–Ω—ã'] },
      { patterns: ['—Ç–æ–ª—å—è—Ç—Ç–∏', 'tolyatti'], dbNames: ['Tolyatti', '–¢–æ–ª—å—è—Ç—Ç–∏'] },
      { patterns: ['–∏–∂–µ–≤—Å–∫', '–∏–∂–µ–≤—Å–∫–µ', 'izhevsk'], dbNames: ['Izhevsk', '–ò–∂–µ–≤—Å–∫'] },
      { patterns: ['—É–ª—å—è–Ω–æ–≤—Å–∫', '—É–ª—å—è–Ω–æ–≤—Å–∫–µ', 'ulyanovsk'], dbNames: ['Ulyanovsk', '–£–ª—å—è–Ω–æ–≤—Å–∫'] },
      { patterns: ['–º–∞—Ö–∞—á–∫–∞–ª–∞', '–º–∞—Ö–∞—á–∫–∞–ª–µ', 'makhachkala'], dbNames: ['Makhachkala', '–ú–∞—Ö–∞—á–∫–∞–ª–∞'] },
      { patterns: ['—Å—Ç–∞–≤—Ä–æ–ø–æ–ª—å', '—Å—Ç–∞–≤—Ä–æ–ø–æ–ª–µ', 'stavropol'], dbNames: ['Stavropol', '–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å'] },

      // –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω
      { patterns: ['–∞–ª–º–∞—Ç—ã', 'almaty', '–∞–ª–º–∞-–∞—Ç–∞', '–∞–ª–º–∞ –∞—Ç–∞'], dbNames: ['Almaty', '–ê–ª–º–∞—Ç—ã', '–ê–ª–º–∞-–ê—Ç–∞'] },
      { patterns: ['–∞—Å—Ç–∞–Ω–∞', '–∞—Å—Ç–∞–Ω–µ', 'astana'], dbNames: ['Astana', '–ê—Å—Ç–∞–Ω–∞', 'Nur-Sultan', '–ù—É—Ä-–°—É–ª—Ç–∞–Ω'] },
      { patterns: ['—à—ã–º–∫–µ–Ω—Ç', '—à—ã–º–∫–µ–Ω—Ç–µ', 'shymkent'], dbNames: ['Shymkent', '–®—ã–º–∫–µ–Ω—Ç'] },
      { patterns: ['–∫–∞—Ä–∞–≥–∞–Ω–¥–∞', '–∫–∞—Ä–∞–≥–∞–Ω–¥–µ', 'karaganda'], dbNames: ['Karaganda', '–ö–∞—Ä–∞–≥–∞–Ω–¥–∞', 'Karagandy'] },
      { patterns: ['–∞–∫—Ç–æ–±–µ', 'aktobe'], dbNames: ['Aktobe', '–ê–∫—Ç–æ–±–µ'] },
      { patterns: ['—Ç–∞—Ä–∞–∑', '—Ç–∞—Ä–∞–∑–µ', 'taraz'], dbNames: ['Taraz', '–¢–∞—Ä–∞–∑'] },
      { patterns: ['–ø–∞–≤–ª–æ–¥–∞—Ä', '–ø–∞–≤–ª–æ–¥–∞—Ä–µ', 'pavlodar'], dbNames: ['Pavlodar', '–ü–∞–≤–ª–æ–¥–∞—Ä'] },
      { patterns: ['—Å–µ–º–µ–π', 'semey'], dbNames: ['Semey', '–°–µ–º–µ–π'] },
      { patterns: ['–∞—Ç—ã—Ä–∞—É', 'atyrau'], dbNames: ['Atyrau', '–ê—Ç—ã—Ä–∞—É'] },
      { patterns: ['–∫–æ—Å—Ç–∞–Ω–∞–π', '–∫–æ—Å—Ç–∞–Ω–∞–µ', 'kostanay'], dbNames: ['Kostanay', '–ö–æ—Å—Ç–∞–Ω–∞–π'] },
      { patterns: ['–∫—ã–∑—ã–ª–æ—Ä–¥–∞', '–∫—ã–∑—ã–ª–æ—Ä–¥–µ', 'kyzylorda'], dbNames: ['Kyzylorda', '–ö—ã–∑—ã–ª–æ—Ä–¥–∞'] },
      { patterns: ['–∞–∫—Ç–∞—É', 'aktau'], dbNames: ['Aktau', '–ê–∫—Ç–∞—É'] },
      { patterns: ['—É—Ä–∞–ª—å—Å–∫', '—É—Ä–∞–ª—å—Å–∫–µ', 'uralsk'], dbNames: ['Uralsk', '–£—Ä–∞–ª—å—Å–∫', 'Oral'] },
      { patterns: ['–ø–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫', '–ø–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫–µ', 'petropavlovsk'], dbNames: ['Petropavlovsk', '–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫'] },
    ];

    // Category/type mappings (Russian search terms ‚Üí English keywords in titles)
    const CATEGORY_KEYWORDS = {
      '–∫–æ–Ω—Ü–µ—Ä—Ç': ['concert', '–∫–æ–Ω—Ü–µ—Ä—Ç', 'live', '—Ç—É—Ä', 'tour'],
      '—Å—Ç–µ–Ω–¥–∞–ø': ['stand-up', 'standup', '—Å—Ç–µ–Ω–¥–∞–ø', '—Å—Ç–µ–Ω–¥-–∞–ø', 'comedy', '–∫–æ–º–µ–¥–∏'],
      '—Ç–µ–∞—Ç—Ä': ['theater', 'theatre', '—Ç–µ–∞—Ç—Ä', '—Å–ø–µ–∫—Ç–∞–∫–ª—å', '–ø—å–µ—Å–∞'],
      '—Å–ø–µ–∫—Ç–∞–∫–ª—å': ['theater', 'theatre', '—Ç–µ–∞—Ç—Ä', '—Å–ø–µ–∫—Ç–∞–∫–ª—å', '–ø—å–µ—Å–∞', '–¥—Ä–∞–º–∞'],
      '–±–∞–ª–µ—Ç': ['ballet', '–±–∞–ª–µ—Ç'],
      '–æ–ø–µ—Ä–∞': ['opera', '–æ–ø–µ—Ä–∞'],
      '–º—é–∑–∏–∫–ª': ['musical', '–º—é–∑–∏–∫–ª'],
      '–≤—ã—Å—Ç–∞–≤–∫–∞': ['exhibition', '–≤—ã—Å—Ç–∞–≤–∫–∞', 'expo', 'exhibit'],
      '—Ñ–µ—Å—Ç–∏–≤–∞–ª—å': ['festival', '—Ñ–µ—Å—Ç–∏–≤–∞–ª—å', 'fest'],
      '—à–æ—É': ['show', '—à–æ—É'],
      '—Ü–∏—Ä–∫': ['circus', '—Ü–∏—Ä–∫'],
      '—Ä–æ–∫': ['rock', '—Ä–æ–∫', 'metal', '–º–µ—Ç–∞–ª'],
      '–¥–∂–∞–∑': ['jazz', '–¥–∂–∞–∑'],
      '–∫–ª–∞—Å—Å–∏–∫–∞': ['classical', '–∫–ª–∞—Å—Å–∏–∫–∞', '—Å–∏–º—Ñ–æ–Ω–∏', 'symphony', 'orchestra', '–æ—Ä–∫–µ—Å—Ç—Ä'],
      '—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è': ['electronic', '—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è', 'techno', 'house', 'dj', '–¥–∏-–¥–∂–µ–π'],
      '—Ö–∏–ø-—Ö–æ–ø': ['hip-hop', 'hiphop', '—Ö–∏–ø-—Ö–æ–ø', 'rap', '—Ä—ç–ø'],
      '–ø–æ–ø': ['pop', '–ø–æ–ø'],
      '–¥–µ—Ç—Å–∫–∏–π': ['kids', '–¥–µ—Ç—Å–∫–∏–π', 'children', '–¥–µ—Ç—è–º', '–¥–ª—è –¥–µ—Ç–µ–π'],
      '–∫–≤–Ω': ['–∫–≤–Ω', 'kvn'],
      '—é–º–æ—Ä': ['comedy', 'humor', '—é–º–æ—Ä', '–∫–æ–º–µ–¥–∏', '—Å–º–µ—Ö', 'stand-up', '—Å—Ç–µ–Ω–¥–∞–ø']
    };

    // ========== –£–õ–£–ß–®–ï–ù–ù–´–ô –ü–û–ò–°–ö –ì–û–†–û–î–û–í ==========
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º word boundary –ø—Ä–æ–≤–µ—Ä–∫—É —á—Ç–æ–±—ã "–º—Å–∫" –Ω–µ –º–∞—Ç—á–∏–ª–æ—Å—å –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–∏—Ö —Å–ª–æ–≤
    function findCityInQuery(query, dbCities) {
      const queryLower = query.toLowerCase();

      // –°–æ–∑–¥–∞—ë–º Set –∏–∑ –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤ –≤ –ë–î –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
      const dbCitiesLower = new Map();
      dbCities.forEach(c => dbCitiesLower.set(c.toLowerCase(), c));

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–ª–∏–∞—Å—ã –≤ –ø–æ—Ä—è–¥–∫–µ (–¥–ª–∏–Ω–Ω—ã–µ –ø–µ—Ä–≤—ã–º–∏ - –æ–Ω–∏ —É–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ –º–∞—Å—Å–∏–≤–µ)
      for (const alias of CITY_ALIASES) {
        for (const pattern of alias.patterns) {
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º word boundary - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ
          // –°–æ–∑–¥–∞—ë–º —Ä–µ–≥—É–ª—è—Ä–∫—É —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ —Å–ª–æ–≤–∞
          const regex = new RegExp(`(^|[\\s,."'¬´¬ª()\\-])${escapeRegex(pattern)}($|[\\s,."'¬´¬ª()\\-])`, 'i');

          if (regex.test(queryLower)) {
            // –ù–∞—à–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω! –¢–µ–ø–µ—Ä—å –∏—â–µ–º –∫–∞–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å—Ç—å –≤ –ë–î
            for (const dbName of alias.dbNames) {
              const found = dbCitiesLower.get(dbName.toLowerCase());
              if (found) {
                return { searchTerm: pattern, dbValue: found, allDbNames: alias.dbNames };
              }
            }
            // –ü–∞—Ç—Ç–µ—Ä–Ω –Ω–∞–π–¥–µ–Ω –Ω–æ –≥–æ—Ä–æ–¥–∞ –Ω–µ—Ç –≤ –ë–î - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –¥–µ–±–∞–≥–∞
            return { searchTerm: pattern, dbValue: null, allDbNames: alias.dbNames, notInDb: true };
          }
        }
      }

      // –ü—Ä—è–º–æ–π –ø–æ–∏—Å–∫ –ø–æ –≥–æ—Ä–æ–¥–∞–º –∏–∑ –ë–î (–µ—Å–ª–∏ –≥–æ—Ä–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ –±–∞–∑–µ)
      for (const [cityLower, cityOriginal] of dbCitiesLower) {
        const regex = new RegExp(`(^|[\\s,."'¬´¬ª()\\-])${escapeRegex(cityLower)}($|[\\s,."'¬´¬ª()\\-])`, 'i');
        if (regex.test(queryLower)) {
          return { searchTerm: cityLower, dbValue: cityOriginal };
        }
      }

      return null;
    }

    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–∫–∏
    function escapeRegex(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // Find matching category from query
    function findCategoryInQuery(query) {
      const queryLower = query.toLowerCase();

      for (const [ruTerm, keywords] of Object.entries(CATEGORY_KEYWORDS)) {
        // –¢–æ–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º word boundary –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        const regex = new RegExp(`(^|[\\s,."'¬´¬ª()\\-])${escapeRegex(ruTerm)}`, 'i');
        if (regex.test(queryLower)) {
          return { searchTerm: ruTerm, keywords: keywords };
        }
      }

      return null;
    }

    function exportCSV() {
      if (filteredData.length === 0) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
      }

      const currency = CURRENCY[selectedRegion];
      const headers = ['–ù–∞–∑–≤–∞–Ω–∏–µ', '–ü–ª–æ—â–∞–¥–∫–∞', '–ì–æ—Ä–æ–¥', '–ñ–∞–Ω—Ä', '–î–∞—Ç–∞', '–î–∞—Ç–∞ –¥–æ', '–î–æ–±–∞–≤–ª–µ–Ω–æ', '–¶–µ–Ω–∞ (' + currency + ')', 'URL', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'];

      const rows = filteredData.map(e => [
        (e.title || '').replace(/"/g, '""'),
        (e.venue || '').replace(/"/g, '""'),
        (e.city || '').replace(/"/g, '""'),
        (e.genre || '').replace(/"/g, '""'),
        e.date_from || '',
        e.date_to || '',
        e.created_at ? e.created_at.substring(0, 10) : '',
        getPrice(e.price),
        e.url || '',
        (e.comments || '').replace(/"/g, '""')
      ]);

      const csvContent = [headers, ...rows]
        .map(row => row.map(cell => `"${cell}"`).join(','))
        .join('\n');

      // Add BOM for Excel UTF-8 compatibility
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = `yaa_events_${selectedRegion}_${selectedPurpose}_${new Date().toISOString().substring(0, 10)}.csv`;
      link.click();

      URL.revokeObjectURL(url);
    }

    // Init
    checkAuth();

    // Flatpickr
    const fpConfig = {
      dateFormat: 'Y-m-d',
      altInput: true,
      altFormat: 'd.m.Y',
      allowInput: true,
      onChange: applyFilters
    };
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/flatpickr';
    script.onload = () => {
      flatpickr('#filter-date-from', fpConfig);
      flatpickr('#filter-date-to', fpConfig);
      flatpickr('#filter-created-from', fpConfig);
      flatpickr('#filter-created-to', fpConfig);
    };
    document.head.appendChild(script);

    // Custom dropdown functions
    function toggleGenreDropdown() {
      const dropdown = document.getElementById('genre-dropdown-content');
      if (!dropdown) return;
      const header = dropdown.previousElementSibling;
      const isOpen = dropdown.style.display === 'block';

      // Close all dropdowns first
      document.querySelectorAll('.custom-dropdown-content').forEach(d => d.style.display = 'none');
      document.querySelectorAll('.custom-dropdown-header').forEach(h => h.classList.remove('open'));

      if (!isOpen) {
        dropdown.style.display = 'block';
        if (header) header.classList.add('open');
        const searchBox = document.getElementById('genre-search');
        if (searchBox) searchBox.focus();
      }
    }

    function toggleGenreSelection(genre) {
      const idx = selectedGenres.indexOf(genre);
      if (idx === -1) {
        selectedGenres.push(genre);
      } else {
        selectedGenres.splice(idx, 1);
      }
      updateSelectedGenresDisplay();
      updateGenreDropdownText();
      renderTable();
    }

    function updateGenreDropdownText() {
      const text = document.getElementById('genre-dropdown-text');
      if (!text) return;

      if (selectedGenres.length === 0) {
        text.textContent = '–í—Å–µ –∂–∞–Ω—Ä—ã';
      } else if (selectedGenres.length === 1) {
        text.textContent = selectedGenres[0];
      } else {
        text.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${selectedGenres.length}`;
      }

      // Update checkboxes
      document.querySelectorAll('#genre-options-list .dropdown-option').forEach(opt => {
        const genre = opt.getAttribute('data-genre');
        if (selectedGenres.includes(genre)) {
          opt.classList.add('selected');
        } else {
          opt.classList.remove('selected');
        }
      });
    }

    function filterGenreOptions() {
      const search = document.getElementById('genre-search');
      if (!search) return;
      const searchText = search.value.toLowerCase();

      document.querySelectorAll('#genre-options-list .dropdown-option').forEach(opt => {
        const text = opt.textContent.toLowerCase();
        opt.style.display = text.includes(searchText) ? 'flex' : 'none';
      });
    }

    function toggleCompetitorGenreDropdown() {
      const dropdown = document.getElementById('competitor-genre-dropdown-content');
      if (!dropdown) return;
      const header = dropdown.previousElementSibling;
      const isOpen = dropdown.style.display === 'block';

      // Close all dropdowns first
      document.querySelectorAll('.custom-dropdown-content').forEach(d => d.style.display = 'none');
      document.querySelectorAll('.custom-dropdown-header').forEach(h => h.classList.remove('open'));

      if (!isOpen) {
        dropdown.style.display = 'block';
        if (header) header.classList.add('open');
        const searchBox = document.getElementById('competitor-genre-search');
        if (searchBox) searchBox.focus();
      }
    }

    function toggleCompetitorGenreSelection(genre) {
      const idx = selectedCompetitorGenres.indexOf(genre);
      if (idx === -1) {
        selectedCompetitorGenres.push(genre);
      } else {
        selectedCompetitorGenres.splice(idx, 1);
      }
      updateCompetitorGenresDisplay();
      updateCompetitorGenreDropdownText();
    }

    function updateCompetitorGenreDropdownText() {
      const text = document.getElementById('competitor-genre-dropdown-text');
      if (!text) return;

      if (selectedCompetitorGenres.length === 0) {
        text.textContent = '–í—Å–µ –∂–∞–Ω—Ä—ã';
      } else if (selectedCompetitorGenres.length === 1) {
        text.textContent = selectedCompetitorGenres[0];
      } else {
        text.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${selectedCompetitorGenres.length}`;
      }

      // Update checkboxes
      document.querySelectorAll('#competitor-genre-options-list .dropdown-option').forEach(opt => {
        const genre = opt.getAttribute('data-genre');
        if (selectedCompetitorGenres.includes(genre)) {
          opt.classList.add('selected');
        } else {
          opt.classList.remove('selected');
        }
      });
    }

    function filterCompetitorGenreOptions() {
      const search = document.getElementById('competitor-genre-search');
      if (!search) return;
      const searchText = search.value.toLowerCase();

      document.querySelectorAll('#competitor-genre-options-list .dropdown-option').forEach(opt => {
        const text = opt.textContent.toLowerCase();
        opt.style.display = text.includes(searchText) ? 'flex' : 'none';
      });
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.custom-dropdown-wrapper')) {
        document.querySelectorAll('.custom-dropdown-content').forEach(d => d.style.display = 'none');
        document.querySelectorAll('.custom-dropdown-header').forEach(h => h.classList.remove('open'));
      }
    });

  </script>
</body>
</html>
